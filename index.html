<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¿®ä»™æ¸¸æˆ - AI Native</title>
  <style>
    /* ==================== åŸºç¡€æ ·å¼ ==================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft YaHei', 'SimSun', sans-serif;
      overflow: hidden;
      background: #1a1a2e;
      color: #e0e0e0;
    }

    /* ==================== æ¸¸æˆå®¹å™¨ ==================== */
    #game-container {
      width: 100vw;
      height: 100vh;
      position: relative;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    }

    /* ==================== æ¸¸æˆç”»å¸ƒ ==================== */
    #game-canvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    /* ==================== UI å±‚ ==================== */
    .ui-layer {
      position: absolute;
      pointer-events: none;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
    }

    .ui-layer > * {
      pointer-events: auto;
    }

    /* ==================== é¡¶éƒ¨çŠ¶æ€æ  ==================== */
    .status-bar {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 10px;
      border: 1px solid rgba(244, 208, 63, 0.3);
    }

    .status-left {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .status-right {
      display: flex;
      gap: 10px;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
    }

    .status-label {
      color: #f4d03f;
      font-weight: bold;
    }

    .status-value {
      color: #fff;
    }

    /* ==================== è¡€æ¡å’Œç»éªŒæ¡ ==================== */
    .bar-container {
      display: flex;
      flex-direction: column;
      gap: 5px;
      min-width: 150px;
    }

    .bar {
      height: 8px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 4px;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    .hp-bar .bar-fill {
      background: linear-gradient(90deg, #c0392b, #e74c3c);
    }

    .exp-bar .bar-fill {
      background: linear-gradient(90deg, #2980b9, #3498db);
    }

    .bar-text {
      font-size: 12px;
      color: #f4d03f;
    }

    /* ==================== åº•éƒ¨æŒ‰é’®æ  ==================== */
    .button-bar {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 10px;
      border: 1px solid rgba(244, 208, 63, 0.3);
    }

    .game-btn {
      background: linear-gradient(135deg, #f4d03f 0%, #16a085 100%);
      color: #1a1a2e;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .game-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
    }

    .game-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* ==================== æ¨¡æ€æ¡† ==================== */
    .modal {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(26, 26, 46, 0.95);
      border-radius: 15px;
      border: 2px solid rgba(244, 208, 63, 0.5);
      padding: 30px;
      min-width: 400px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      display: none;
      z-index: 1000;
    }

    .modal.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(244, 208, 63, 0.3);
    }

    .modal-title {
      font-size: 24px;
      font-weight: bold;
      color: #f4d03f;
    }

    .modal-close {
      background: #c0392b;
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: #e74c3c;
      transform: rotate(90deg);
    }

    .modal-content {
      max-height: 60vh;
      overflow-y: auto;
    }

    /* ==================== è§’è‰²é¢æ¿ ==================== */
    .character-panel {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .character-section {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 10px;
      border: 1px solid rgba(244, 208, 63, 0.2);
    }

    .character-section h3 {
      color: #f4d03f;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(244, 208, 63, 0.1);
    }

    .stat-label {
      color: #f4d03f;
    }

    .stat-value {
      color: #fff;
      font-weight: bold;
    }

    /* ==================== å¯¹è¯æ¡† ==================== */
    .dialog-box {
      background: rgba(255, 255, 255, 0.95);
      color: #1a1a2e;
      padding: 20px;
      border-radius: 10px;
      border: 2px solid #f4d03f;
      max-width: 500px;
    }

    .dialog-npc {
      font-weight: bold;
      color: #f4d03f;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .dialog-text {
      margin-bottom: 15px;
      line-height: 1.6;
    }

    .dialog-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .dialog-option {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      text-align: left;
      transition: all 0.3s ease;
    }

    .dialog-option:hover {
      background: linear-gradient(135deg, #5dade2, #3498db);
      transform: translateX(5px);
    }

    /* ==================== æ¶ˆæ¯æç¤º ==================== */
    .toast {
      position: absolute;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: #f4d03f;
      padding: 15px 30px;
      border-radius: 10px;
      border: 1px solid rgba(244, 208, 63, 0.5);
      font-size: 16px;
      font-weight: bold;
      z-index: 1000;
      display: none;
      animation: slideDown 0.3s ease;
    }

    .toast.show {
      display: block;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    /* ==================== åŠ è½½ç•Œé¢ ==================== */
    .loading-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .loading-title {
      font-size: 48px;
      font-weight: bold;
      color: #f4d03f;
      margin-bottom: 30px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    .loading-bar {
      width: 300px;
      height: 10px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 5px;
      overflow: hidden;
    }

    .loading-progress {
      height: 100%;
      background: linear-gradient(90deg, #f4d03f, #16a085);
      width: 0%;
      transition: width 0.3s ease;
    }

    .loading-text {
      margin-top: 20px;
      color: #f4d03f;
      font-size: 18px;
    }

    /* ==================== æ»šåŠ¨æ¡æ ·å¼ ==================== */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(244, 208, 63, 0.5);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(244, 208, 63, 0.8);
    }

    /* ==================== å“åº”å¼è®¾è®¡ ==================== */
    @media (max-width: 768px) {
      .status-bar {
        flex-direction: column;
        gap: 10px;
      }

      .status-left {
        flex-wrap: wrap;
      }

      .button-bar {
        width: 90%;
        flex-wrap: wrap;
        justify-content: center;
      }

      .modal {
        width: 90%;
        min-width: auto;
      }

      .character-panel {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- æ¸¸æˆå®¹å™¨ -->
  <div id="game-container">
    <!-- æ¸¸æˆç”»å¸ƒ -->
    <canvas id="game-canvas"></canvas>

    <!-- UI å±‚ -->
    <div class="ui-layer">
      <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
      <div class="status-bar" id="status-bar" style="display: none;">
        <div class="status-left">
          <div class="bar-container">
            <div class="bar hp-bar">
              <div class="bar-fill" id="hp-bar-fill" style="width: 100%;"></div>
            </div>
            <div class="bar-text" id="hp-bar-text">HP: 100/100</div>
          </div>
          <div class="bar-container">
            <div class="bar exp-bar">
              <div class="bar-fill" id="exp-bar-fill" style="width: 0%;"></div>
            </div>
            <div class="bar-text" id="exp-bar-text">EXP: 0/100</div>
          </div>
          <div class="status-item">
            <span class="status-label">ç­‰çº§:</span>
            <span class="status-value" id="level-value">1</span>
          </div>
          <div class="status-item">
            <span class="status-label">é‡‘å¸:</span>
            <span class="status-value" id="gold-value">0</span>
          </div>
        </div>
        <div class="status-right">
          <div class="status-item">
            <span class="status-label">åœ°å›¾:</span>
            <span class="status-value" id="map-value">æ‘åº„</span>
          </div>
        </div>
      </div>

      <!-- åº•éƒ¨æŒ‰é’®æ  -->
      <div class="button-bar" id="button-bar" style="display: none;">
        <button class="game-btn" onclick="openCharacterPanel()">ğŸ‘¤ è§’è‰²</button>
        <button class="game-btn" onclick="openInventoryPanel()">ğŸ’ èƒŒåŒ…</button>
        <button class="game-btn" onclick="openSkillsPanel()">âš”ï¸ æŠ€èƒ½</button>
        <button class="game-btn" onclick="openTasksPanel()">ğŸ“‹ ä»»åŠ¡</button>
        <button class="game-btn" onclick="saveGame()">ğŸ’¾ ä¿å­˜</button>
      </div>

      <!-- æ¶ˆæ¯æç¤º -->
      <div class="toast" id="toast"></div>
    </div>

    <!-- è§’è‰²é¢æ¿æ¨¡æ€æ¡† -->
    <div class="modal" id="character-modal">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ‘¤ è§’è‰²ä¿¡æ¯</h2>
        <button class="modal-close" onclick="closeModal('character-modal')">&times;</button>
      </div>
      <div class="modal-content">
        <div class="character-panel" id="character-content">
          <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>

    <!-- èƒŒåŒ…é¢æ¿æ¨¡æ€æ¡† -->
    <div class="modal" id="inventory-modal">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ’ èƒŒåŒ…</h2>
        <button class="modal-close" onclick="closeModal('inventory-modal')">&times;</button>
      </div>
      <div class="modal-content" id="inventory-content">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>

    <!-- æŠ€èƒ½é¢æ¿æ¨¡æ€æ¡† -->
    <div class="modal" id="skills-modal">
      <div class="modal-header">
        <h2 class="modal-title">âš”ï¸ æŠ€èƒ½</h2>
        <button class="modal-close" onclick="closeModal('skills-modal')">&times;</button>
      </div>
      <div class="modal-content" id="skills-content">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>

    <!-- ä»»åŠ¡é¢æ¿æ¨¡æ€æ¡† -->
    <div class="modal" id="tasks-modal">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“‹ ä»»åŠ¡</h2>
        <button class="modal-close" onclick="closeModal('tasks-modal')">&times;</button>
      </div>
      <div class="modal-content" id="tasks-content">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>

    <!-- å¯¹è¯æ¡†æ¨¡æ€æ¡† -->
    <div class="modal" id="dialog-modal">
      <div class="dialog-box">
        <div class="dialog-npc" id="dialog-npc">NPC åå­—</div>
        <div class="dialog-text" id="dialog-text">å¯¹è¯å†…å®¹</div>
        <div class="dialog-options" id="dialog-options">
          <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>

    <!-- åŠ è½½ç•Œé¢ -->
    <div class="loading-screen" id="loading-screen">
      <h1 class="loading-title">ä¿®ä»™æ¸¸æˆ</h1>
      <div class="loading-bar">
        <div class="loading-progress" id="loading-progress"></div>
      </div>
      <div class="loading-text" id="loading-text">åŠ è½½ä¸­...</div>
    </div>
  </div>

  <script type="module">
    import coordinatorAPI from './js/coordinator-api.js';

    // å…¨å±€å˜é‡
    let gameState = null;
    let canvas = null;
    let ctx = null;

    // åˆå§‹åŒ–æ¸¸æˆ
    async function initGame() {
      try {
        showLoading('åˆå§‹åŒ–æ¸¸æˆ...', 10);

        // åˆå§‹åŒ–åè°ƒ Agent
        gameState = await coordinatorAPI.initGame();

        showLoading('åŠ è½½èµ„æº...', 30);

        // åˆå§‹åŒ–ç”»å¸ƒ
        canvas = document.getElementById('game-canvas');
        ctx = canvas.getContext('2d');
        resizeCanvas();

        showLoading('å‡†å¤‡æ¸¸æˆ...', 60);

        // æ˜¾ç¤º UI
        document.getElementById('status-bar').style.display = 'flex';
        document.getElementById('button-bar').style.display = 'flex';

        // æ›´æ–° UI
        updateUI();

        showLoading('å®Œæˆ!', 100);

        // éšè—åŠ è½½ç•Œé¢
        setTimeout(() => {
          hideLoading();
        }, 500);

        // å¼€å§‹æ¸¸æˆå¾ªç¯
        gameLoop();
      } catch (error) {
        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        showToast('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
      }
    }

    // è°ƒæ•´ç”»å¸ƒå¤§å°
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }

    // æ¸¸æˆå¾ªç¯
    function gameLoop() {
      update();
      render();
      requestAnimationFrame(gameLoop);
    }

    // æ›´æ–°é€»è¾‘
    function update() {
      // æ¸¸æˆé€»è¾‘æ›´æ–°
    }

    // æ¸²æŸ“
    function render() {
      // æ¸…ç©ºç”»å¸ƒ
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // æ¸²æŸ“æ¸¸æˆåœºæ™¯
      renderScene();
    }

    // æ¸²æŸ“åœºæ™¯
    function renderScene() {
      // ç»˜åˆ¶èƒŒæ™¯
      ctx.fillStyle = '#1a1a2e';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // ç»˜åˆ¶ç©å®¶ä½ç½®
      if (gameState && gameState.player && gameState.player.position) {
        const pos = gameState.player.position;

        // ç»˜åˆ¶ç©å®¶
        ctx.beginPath();
        ctx.arc(pos.x, pos.y, 20, 0, Math.PI * 2);
        ctx.fillStyle = '#f4d03f';
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();

        // ç»˜åˆ¶åå­—
        ctx.fillStyle = '#fff';
        ctx.font = '16px Microsoft YaHei';
        ctx.textAlign = 'center';
        ctx.fillText(gameState.player.name || 'ç©å®¶', pos.x, pos.y - 30);
      }
    }

    // æ›´æ–° UI
    function updateUI() {
      if (!gameState || !gameState.player) return;

      const player = gameState.player;

      // æ›´æ–°è¡€æ¡
      const hpPercent = (player.hp / player.maxHp) * 100;
      document.getElementById('hp-bar-fill').style.width = hpPercent + '%';
      document.getElementById('hp-bar-text').textContent = `HP: ${player.hp}/${player.maxHp}`;

      // æ›´æ–°ç»éªŒæ¡
      const expPercent = (player.exp / player.expToNextLevel) * 100;
      document.getElementById('exp-bar-fill').style.width = expPercent + '%';
      document.getElementById('exp-bar-text').textContent = `EXP: ${player.exp}/${player.expToNextLevel}`;

      // æ›´æ–°ç­‰çº§å’Œé‡‘å¸
      document.getElementById('level-value').textContent = player.level;
      document.getElementById('gold-value').textContent = player.gold;

      // æ›´æ–°åœ°å›¾
      const mapNames = {
        'village': 'æ‘åº„',
        'forest': 'æ£®æ—',
        'cave': 'å±±æ´',
        'desert': 'æ²™æ¼ ',
        'snow': 'å†°åŸ',
        'volcano': 'ç«å±±',
        'demon_palace': 'é­”å®«'
      };
      document.getElementById('map-value').textContent = mapNames[gameState.currentMap] || gameState.currentMap;
    }

    // æ‰“å¼€è§’è‰²é¢æ¿
    window.openCharacterPanel = function() {
      if (!gameState || !gameState.player) return;

      const player = gameState.player;
      const content = document.getElementById('character-content');

      content.innerHTML = `
        <div class="character-section">
          <h3>ğŸ‘¤ åŸºæœ¬ä¿¡æ¯</h3>
          <div class="stat-row">
            <span class="stat-label">åå­—:</span>
            <span class="stat-value">${player.name || 'æœªå‘½å'}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">èŒä¸š:</span>
            <span class="stat-value">${player.class || 'æœªé€‰æ‹©'}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">ç­‰çº§:</span>
            <span class="stat-value">${player.level}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">ç»éªŒ:</span>
            <span class="stat-value">${player.exp}/${player.expToNextLevel}</span>
          </div>
        </div>
        <div class="character-section">
          <h3>âš”ï¸ æˆ˜æ–—å±æ€§</h3>
          <div class="stat-row">
            <span class="stat-label">ç”Ÿå‘½å€¼:</span>
            <span class="stat-value">${player.hp}/${player.maxHp}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">æ”»å‡»åŠ›:</span>
            <span class="stat-value">${player.attack}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">é˜²å¾¡åŠ›:</span>
            <span class="stat-value">${player.defense}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">é‡‘å¸:</span>
            <span class="stat-value">${player.gold}</span>
          </div>
        </div>
      `;

      openModal('character-modal');
    };

    // æ‰“å¼€èƒŒåŒ…é¢æ¿
    window.openInventoryPanel = function() {
      const content = document.getElementById('inventory-content');

      if (!gameState || gameState.inventory.length === 0) {
        content.innerHTML = '<p style="text-align: center; color: #999;">èƒŒåŒ…æ˜¯ç©ºçš„</p>';
      } else {
        content.innerHTML = gameState.inventory.map((item, index) => `
          <div class="character-section" style="margin-bottom: 10px;">
            <div class="stat-row">
              <span class="stat-label">åç§°:</span>
              <span class="stat-value">${item.name}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">æ•°é‡:</span>
              <span class="stat-value">${item.quantity}</span>
            </div>
          </div>
        `).join('');
      }

      openModal('inventory-modal');
    };

    // æ‰“å¼€æŠ€èƒ½é¢æ¿
    window.openSkillsPanel = function() {
      const content = document.getElementById('skills-content');

      if (!gameState || gameState.skills.length === 0) {
        content.innerHTML = '<p style="text-align: center; color: #999;">è¿˜æ²¡æœ‰å­¦ä¹ æŠ€èƒ½</p>';
      } else {
        content.innerHTML = gameState.skills.map((skill, index) => `
          <div class="character-section" style="margin-bottom: 10px;">
            <div class="stat-row">
              <span class="stat-label">åç§°:</span>
              <span class="stat-value">${skill.name}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">ç­‰çº§:</span>
              <span class="stat-value">${skill.level}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">æè¿°:</span>
              <span class="stat-value">${skill.description}</span>
            </div>
          </div>
        `).join('');
      }

      openModal('skills-modal');
    };

    // æ‰“å¼€ä»»åŠ¡é¢æ¿
    window.openTasksPanel = function() {
      const content = document.getElementById('tasks-content');

      if (!gameState || gameState.tasks.length === 0) {
        content.innerHTML = '<p style="text-align: center; color: #999;">è¿˜æ²¡æœ‰ä»»åŠ¡</p>';
      } else {
        content.innerHTML = gameState.tasks.map((task, index) => `
          <div class="character-section" style="margin-bottom: 10px;">
            <div class="stat-row">
              <span class="stat-label">ä»»åŠ¡:</span>
              <span class="stat-value">${task.title}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">çŠ¶æ€:</span>
              <span class="stat-value" style="color: ${task.completed ? '#27ae60' : '#e74c3c'};">
                ${task.completed ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}
              </span>
            </div>
            ${task.completed && task.rewards ? `
              <div class="stat-row">
                <span class="stat-label">å¥–åŠ±:</span>
                <span class="stat-value">é‡‘å¸ ${task.rewards.gold}, ç»éªŒ ${task.rewards.exp}</span>
              </div>
            ` : ''}
          </div>
        `).join('');
      }

      openModal('tasks-modal');
    };

    // ä¿å­˜æ¸¸æˆ
    window.saveGame = async function() {
      try {
        const success = await coordinatorAPI.saveGame();
        if (success) {
          showToast('æ¸¸æˆå·²ä¿å­˜');
        } else {
          showToast('ä¿å­˜å¤±è´¥');
        }
      } catch (error) {
        showToast('ä¿å­˜å¤±è´¥: ' + error.message);
      }
    };

    // æ‰“å¼€æ¨¡æ€æ¡†
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    // å…³é—­æ¨¡æ€æ¡†
    window.closeModal = function(modalId) {
      document.getElementById(modalId).classList.remove('active');
    };

    // æ˜¾ç¤ºåŠ è½½ç•Œé¢
    function showLoading(text, progress) {
      const loadingScreen = document.getElementById('loading-screen');
      const loadingText = document.getElementById('loading-text');
      const loadingProgress = document.getElementById('loading-progress');

      loadingText.textContent = text;
      loadingProgress.style.width = progress + '%';
    }

    // éšè—åŠ è½½ç•Œé¢
    function hideLoading() {
      document.getElementById('loading-screen').style.display = 'none';
    }

    // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // ç‚¹å‡»ç”»å¸ƒç§»åŠ¨ç©å®¶
    canvas.addEventListener('click', async (e) => {
      if (!gameState) return;

      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      try {
        await coordinatorAPI.playerMove(x, y, 'down');
        updateUI();
      } catch (error) {
        showToast('ç§»åŠ¨å¤±è´¥: ' + error.message);
      }
    });

    // çª—å£å¤§å°æ”¹å˜
    window.addEventListener('resize', resizeCanvas);

    // åˆå§‹åŒ–æ¸¸æˆ
    window.addEventListener('load', initGame);

    // å¯¼å‡ºå…¨å±€å‡½æ•°ï¼ˆç”¨äºè°ƒè¯•ï¼‰
    window.coordinatorAPI = coordinatorAPI;
    window.gameState = () => gameState;
  </script>
</body>
</html>

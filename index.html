<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®ä»™ä¼ è¯´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #fff;
        }

        #game-container {
            width: 900px;
            height: 600px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        #game-canvas {
            width: 600px;
            height: 600px;
            float: left;
            background: #1a1a2e;
        }

        #ui-panel {
            width: 300px;
            height: 600px;
            float: right;
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            overflow-y: auto;
        }

        .panel-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .panel-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #f093fb;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 5px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 14px;
        }

        .info-label {
            color: #aaa;
        }

        .info-value {
            color: #fff;
            font-weight: bold;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow: hidden;
            margin: 5px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .btn {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .panel-section {
            animation: fadeIn 0.3s ease-out;
        }

        #log-panel {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.5;
        }

        .log-entry {
            padding: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-info {
            color: #4ecdc4;
        }

        .log-success {
            color: #95e1d3;
        }

        .log-warning {
            color: #fce38a;
        }

        .log-danger {
            color: #f38181;
        }

        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        #start-screen h1 {
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(102, 126, 234, 0.8);
        }

        #start-screen .btn {
            width: 200px;
            padding: 15px;
            font-size: 18px;
            margin: 10px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="game-canvas" width="600" height="600"></canvas>

        <div id="ui-panel">
            <div class="panel-section">
                <div class="panel-title">è§’è‰²ä¿¡æ¯</div>
                <div class="info-row">
                    <span class="info-label">åå­—</span>
                    <span class="info-value" id="character-name">ä¸»è§’</span>
                </div>
                <div class="info-row">
                    <span class="info-label">èŒä¸š</span>
                    <span class="info-value" id="character-class">å‰‘ä¿®</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ç­‰çº§</span>
                    <span class="info-value" id="level">1</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ç”Ÿå‘½</span>
                    <span class="info-value" id="hp">100/100</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="hp-bar" style="width: 100%"></div>
                </div>
                <div class="info-row">
                    <span class="info-label">ç»éªŒ</span>
                    <span class="info-value" id="exp">0/100</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="exp-bar" style="width: 0%"></div>
                </div>
                <div class="info-row">
                    <span class="info-label">é‡‘å¸</span>
                    <span class="info-value" id="gold">100</span>
                </div>
                <div class="info-row">
                    <span class="info-label">æ”»å‡»</span>
                    <span class="info-value" id="attack">10</span>
                </div>
                <div class="info-row">
                    <span class="info-label">é˜²å¾¡</span>
                    <span class="info-value" id="defense">5</span>
                </div>
            </div>

            <div class="panel-section">
                <div class="panel-title">åœ°å›¾ä¿¡æ¯</div>
                <div class="info-row">
                    <span class="info-label">å½“å‰åœ°å›¾</span>
                    <span class="info-value" id="map-name">æ–°æ‰‹æ‘</span>
                </div>
                <div class="info-row">
                    <span class="info-label">å…³å¡è¿›åº¦</span>
                    <span class="info-value" id="level-progress">0/10</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="level-progress-bar" style="width: 0%"></div>
                </div>
                <div class="info-row">
                    <span class="info-label">æ€ªç‰©æ•°é‡</span>
                    <span class="info-value" id="monster-count">0</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ç­‰çº§è¦æ±‚</span>
                    <span class="info-value" id="map-level">1-5</span>
                </div>
                <button class="btn" onclick="prevMap()">â† ä¸Šä¸€ä¸ªåœ°å›¾</button>
                <button class="btn" onclick="nextMap()">ä¸‹ä¸€ä¸ªåœ°å›¾ â†’</button>
                <button class="btn" onclick="talkToNPC()">å¯¹è¯ NPC</button>
            </div>

            <div class="panel-section">
                <div class="panel-title">æ“ä½œ</div>
                <button class="btn" id="btn-explore" onclick="explore()">æ¢ç´¢</button>
                <button class="btn" id="btn-rest" onclick="rest()">ä¼‘æ¯</button>
                <button class="btn" id="btn-shop" onclick="openShop()">å•†åº—</button>
                <button class="btn" id="btn-inventory" onclick="openInventory()">èƒŒåŒ…</button>
                <button class="btn" onclick="showQuestModal()">ä»»åŠ¡</button>
            </div>

            <div class="panel-section">
                <div class="panel-title">æ¸¸æˆæ—¥å¿—</div>
                <div id="log-panel"></div>
            </div>
        </div>

        <div id="start-screen">
            <h1>ä¿®ä»™ä¼ è¯´</h1>
            <button class="btn" onclick="startGame()">ç»§ç»­æ¸¸æˆ</button>
            <button class="btn" onclick="createNewCharacter()">åˆ›å»ºè§’è‰²</button>
        </div>
    </div>

    <script>
        // æ¸¸æˆå…¨å±€å˜é‡
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');

        let gameState = {
            started: false,
            name: 'ä¸»è§’',
            className: 'å‰‘ä¿®',
            class: 'swordsman',
            icon: 'âš”ï¸',
            level: 1,
            hp: 100,
            maxHp: 100,
            mp: 50,
            maxMp: 50,
            exp: 0,
            expToLevel: 100,
            attack: 10,
            defense: 5,
            currentMap: 'æ–°æ‰‹æ‘',
            monsters: [],
            gold: 100,
            skills: [],
            equipment: {
                weapon: null,
                armor: null,
                accessory: null
            },
            inventory: [],
            activeQuests: [],
            completedQuests: [],
            images: {
                idle: null,
                attack: null,
                injured: null,
                victory: null
            }
        };

        // åœ°å›¾æ•°æ®
        const maps = {
            'æ–°æ‰‹æ‘': {
                name: 'æ–°æ‰‹æ‘',
                monsters: [],
                monsterTypes: ['å²è±å§†', 'å…”å­'],
                bgColor: '#2d3748',
                gridColor: '#4a5568',
                minLevel: 1,
                maxLevel: 5,
                level: 1,
                monstersDefeated: 0,
                monstersToDefeat: 10,
                reward: { gold: 100, exp: 50 },
                unlocked: true,
                completed: false
            },
            'æ£®æ—': {
                name: 'æ£®æ—',
                monsters: [],
                monsterTypes: ['ç‹¼', 'é‡çŒª'],
                bgColor: '#22543d',
                gridColor: '#2f855a',
                minLevel: 3,
                maxLevel: 10,
                level: 2,
                monstersDefeated: 0,
                monstersToDefeat: 20,
                reward: { gold: 300, exp: 150 },
                unlocked: false,
                completed: false
            },
            'å±±æ´': {
                name: 'å±±æ´',
                monsters: [],
                monsterTypes: ['è™è ', 'éª·é«…'],
                bgColor: '#1a202c',
                gridColor: '#4a5568',
                minLevel: 5,
                maxLevel: 15,
                level: 3,
                monstersDefeated: 0,
                monstersToDefeat: 30,
                reward: { gold: 500, exp: 300 },
                unlocked: false,
                completed: false
            },
            'ä»™å±±': {
                name: 'ä»™å±±',
                monsters: [],
                monsterTypes: ['çµå…½', 'å®ˆæŠ¤å…½'],
                bgColor: '#553c9a',
                gridColor: '#805ad5',
                minLevel: 10,
                maxLevel: 20,
                level: 4,
                monstersDefeated: 0,
                monstersToDefeat: 50,
                reward: { gold: 1000, exp: 500 },
                unlocked: false,
                completed: false
            }
        };

        // åœ°å›¾åˆ—è¡¨
        const mapList = ['æ–°æ‰‹æ‘', 'æ£®æ—', 'å±±æ´', 'ä»™å±±'];

        // å½“å‰åœ°å›¾ç´¢å¼•
        let currentMapIndex = 0;

        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // æ›´æ–°æ¸¸æˆçŠ¶æ€
        function update() {
            if (!gameState.started) return;
            // æ·»åŠ æ›´æ–°é€»è¾‘
        }

        // ç»˜åˆ¶æ¸¸æˆç”»é¢
        function draw() {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (!gameState.started) return;

            // ç»˜åˆ¶åœ°å›¾èƒŒæ™¯
            drawMap();

            // ç»˜åˆ¶æ€ªç‰©
            drawMonsters();

            // ç»˜åˆ¶è§’è‰²
            drawPlayer();
        }

        // ç»˜åˆ¶åœ°å›¾
        function drawMap() {
            const map = maps[gameState.currentMap];
            ctx.fillStyle = map.bgColor;
            ctx.fillRect(50, 50, 500, 500);

            // ç»˜åˆ¶ç½‘æ ¼
            ctx.strokeStyle = map.gridColor;
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                ctx.beginPath();
                ctx.moveTo(50 + i * 100, 50);
                ctx.lineTo(50 + i * 100, 550);
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(50, 50 + i * 100);
                ctx.lineTo(550, 50 + i * 100);
                ctx.stroke();
            }

            // ç»˜åˆ¶åœ°å›¾åç§°
            ctx.fillStyle = '#fff';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(map.name, 300, 35);
        }

        // åˆ‡æ¢åœ°å›¾
        function switchMap(mapName) {
            const map = maps[mapName];

            // æ£€æŸ¥åœ°å›¾æ˜¯å¦è§£é”
            if (!map.unlocked) {
                addLog(`è¯¥åœ°å›¾å°šæœªè§£é”ï¼`, 'danger');
                return;
            }

            // æ£€æŸ¥ç­‰çº§é™åˆ¶
            if (gameState.level < map.minLevel) {
                addLog(`ç­‰çº§ä¸è¶³ï¼éœ€è¦ç­‰çº§ ${map.minLevel} æ‰èƒ½è¿›å…¥${mapName}`, 'danger');
                return;
            }

            // æ¸…ç©ºå½“å‰åœ°å›¾æ€ªç‰©
            maps[gameState.currentMap].monsters = [];

            // åˆ‡æ¢åœ°å›¾
            gameState.currentMap = mapName;
            gameState.monsters = [];

            // ç”Ÿæˆæ–°æ€ªç‰©
            spawnMonsters();

            addLog(`è¿›å…¥${mapName}`, 'info');
            addLog(`å…³å¡è¿›åº¦ï¼š${map.monstersDefeated}/${map.monstersToDefeat}`, 'info');
            updateUI();
            saveGame();
        }

        // è§£é”åœ°å›¾
        function unlockMap(mapName) {
            maps[mapName].unlocked = true;
            addLog(`è§£é”æ–°åœ°å›¾ï¼š${mapName}ï¼`, 'success');
            saveGame();
        }

        // å®Œæˆå…³å¡
        function completeLevel(mapName) {
            const map = maps[mapName];

            if (map.completed) {
                return;
            }

            map.completed = true;

            // ç»™äºˆå¥–åŠ±
            gainExp(map.reward.exp);
            gainGold(map.reward.gold);

            addLog(`å…³å¡ ${map.level} å®Œæˆï¼`, 'success');
            addLog(`è·å¾—å¥–åŠ±ï¼šé‡‘å¸ ${map.reward.gold}ï¼Œç»éªŒ ${map.reward.exp}`, 'success');

            // è§£é”ä¸‹ä¸€å¼ åœ°å›¾
            const nextMapIndex = mapList.indexOf(mapName) + 1;
            if (nextMapIndex < mapList.length) {
                unlockMap(mapList[nextMapIndex]);
            }

            saveGame();
        }

        // æ£€æŸ¥å…³å¡è¿›åº¦
        function checkLevelProgress() {
            const map = maps[gameState.currentMap];

            if (!map.completed && map.monstersDefeated >= map.monstersToDefeat) {
                completeLevel(gameState.currentMap);
            }
        }

        // ä¸‹ä¸€ä¸ªåœ°å›¾
        function nextMap() {
            currentMapIndex = (currentMapIndex + 1) % mapList.length;
            switchMap(mapList[currentMapIndex]);
        }

        // ä¸Šä¸€ä¸ªåœ°å›¾
        function prevMap() {
            currentMapIndex = (currentMapIndex - 1 + mapList.length) % mapList.length;
            switchMap(mapList[currentMapIndex]);
        }

        // ç»˜åˆ¶æ€ªç‰©
        function drawMonsters() {
            gameState.monsters.forEach(monster => {
                ctx.fillStyle = monster.color || '#ff6b6b';
                ctx.beginPath();
                ctx.arc(monster.x, monster.y, 15, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = '#fff';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(monster.name, monster.x, monster.y - 20);
                ctx.fillText(`Lv.${monster.level}`, monster.x, monster.y - 35);
            });
        }

        // æ€ªç‰©æ•°æ®
        const monsterTypes = {
            'å²è±å§†': { hp: 30, attack: 5, defense: 2, exp: 10, gold: 5, color: '#68d391' },
            'å…”å­': { hp: 40, attack: 8, defense: 3, exp: 15, gold: 8, color: '#fff5f5' },
            'ç‹¼': { hp: 60, attack: 12, defense: 5, exp: 25, gold: 15, color: '#a0aec0' },
            'é‡çŒª': { hp: 80, attack: 15, defense: 8, exp: 35, gold: 20, color: '#c05621' },
            'è™è ': { hp: 50, attack: 18, defense: 4, exp: 40, gold: 25, color: '#805ad5' },
            'éª·é«…': { hp: 100, attack: 22, defense: 10, exp: 50, gold: 30, color: '#e2e8f0' },
            'çµå…½': { hp: 150, attack: 30, defense: 15, exp: 80, gold: 50, color: '#4fd1c5' },
            'å®ˆæŠ¤å…½': { hp: 200, attack: 40, defense: 20, exp: 120, gold: 80, color: '#f687b3' }
        };

        // ç”Ÿæˆæ€ªç‰©
        function spawnMonsters() {
            const map = maps[gameState.currentMap];
            gameState.monsters = [];

            const monsterCount = Math.floor(Math.random() * 3) + 3; // 3-5 ä¸ªæ€ªç‰©

            for (let i = 0; i < monsterCount; i++) {
                const monsterTypeName = map.monsterTypes[Math.floor(Math.random() * map.monsterTypes.length)];
                const monsterType = monsterTypes[monsterTypeName];
                const monsterLevel = map.minLevel + Math.floor(Math.random() * (map.maxLevel - map.minLevel));

                gameState.monsters.push({
                    name: monsterTypeName,
                    level: monsterLevel,
                    hp: monsterType.hp + (monsterLevel - 1) * 10,
                    maxHp: monsterType.hp + (monsterLevel - 1) * 10,
                    attack: monsterType.attack + (monsterLevel - 1) * 3,
                    defense: monsterType.defense + (monsterLevel - 1) * 2,
                    exp: monsterType.exp + (monsterLevel - 1) * 5,
                    gold: monsterType.gold + (monsterLevel - 1) * 3,
                    color: monsterType.color,
                    x: 100 + Math.random() * 400,
                    y: 100 + Math.random() * 400
                });
            }

            updateUI();
        }

        // æ¢ç´¢æ€ªç‰©
        function explore() {
            if (!gameState.started) return;

            if (gameState.monsters.length === 0) {
                addLog('å½“å‰åœ°å›¾æ²¡æœ‰æ€ªç‰©ï¼Œæ­£åœ¨ç”Ÿæˆæ–°æ€ªç‰©...', 'info');
                spawnMonsters();
                return;
            }

            // éšæœºé€‰æ‹©ä¸€ä¸ªæ€ªç‰©è¿›å…¥æˆ˜æ–—
            const monsterIndex = Math.floor(Math.random() * gameState.monsters.length);
            const monster = gameState.monsters[monsterIndex];

            addLog(`å‘ç°äº† ${monster.name}ï¼ˆLv.${monster.level}ï¼‰ï¼`, 'warning');
            addLog(`ç”Ÿå‘½ï¼š${monster.hp} | æ”»å‡»ï¼š${monster.attack} | é˜²å¾¡ï¼š${monster.defense}`, 'info');

            startBattle(monsterIndex);
        }

        // ç»˜åˆ¶è§’è‰²
        function drawPlayer() {
            ctx.fillStyle = '#4ecdc4';
            ctx.beginPath();
            ctx.arc(300, 300, 20, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = '#fff';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('ä¸»è§’', 300, 340);
        }

        // æ›´æ–° UI
        function updateUI() {
            document.getElementById('character-name').textContent = gameState.name;
            document.getElementById('character-class').textContent = gameState.className;
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('hp').textContent = `${gameState.hp}/${gameState.maxHp}`;
            document.getElementById('exp').textContent = `${gameState.exp}/${gameState.expToLevel}`;
            document.getElementById('gold').textContent = gameState.gold;
            document.getElementById('attack').textContent = gameState.attack;
            document.getElementById('defense').textContent = gameState.defense;
            document.getElementById('map-name').textContent = gameState.currentMap;
            document.getElementById('monster-count').textContent = gameState.monsters.length;

            const currentMap = maps[gameState.currentMap];
            document.getElementById('map-level').textContent = `${currentMap.minLevel}-${currentMap.maxLevel}`;
            document.getElementById('level-progress').textContent = `${currentMap.monstersDefeated}/${currentMap.monstersToDefeat}`;
            document.getElementById('level-progress-bar').style.width = `${(currentMap.monstersDefeated / currentMap.monstersToDefeat) * 100}%`;

            // æ›´æ–°è¿›åº¦æ¡
            document.getElementById('hp-bar').style.width = `${(gameState.hp / gameState.maxHp) * 100}%`;
            document.getElementById('exp-bar').style.width = `${(gameState.exp / gameState.expToLevel) * 100}%`;
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const logPanel = document.getElementById('log-panel');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = message;
            logPanel.insertBefore(logEntry, logPanel.firstChild);

            // é™åˆ¶æ—¥å¿—æ•°é‡
            if (logPanel.children.length > 20) {
                logPanel.removeChild(logPanel.lastChild);
            }
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            // æ£€æŸ¥æ˜¯å¦æœ‰è§’è‰²æ•°æ®
            const character = localStorage.getItem('character');
            if (!character) {
                // æ²¡æœ‰è§’è‰²ï¼Œè·³è½¬åˆ°è§’è‰²åˆ›å»ºé¡µé¢
                window.location.href = 'character-creation.html';
                return;
            }

            // åŠ è½½è§’è‰²æ•°æ®
            loadCharacter();

            gameState.started = true;
            document.getElementById('start-screen').style.display = 'none';
            addLog('æ¬¢è¿æ¥åˆ°ä¿®ä»™ä¸–ç•Œï¼', 'success');
            addLog(`å½“å‰è§’è‰²ï¼š${gameState.name}ï¼ˆ${gameState.className}ï¼‰`, 'info');
            addLog('å½“å‰åœ°å›¾ï¼šæ–°æ‰‹æ‘', 'info');
            addLog('ç‚¹å‡»"æ¢ç´¢"å¼€å§‹å†’é™©', 'info');
            updateStats();
            spawnMonsters();
            updateUI();
            gameLoop();
        }

        // åˆ›å»ºæ–°è§’è‰²
        function createNewCharacter() {
            window.location.href = 'character-creation.html';
        }

        // åŠ è½½è§’è‰²æ•°æ®
        function loadCharacter() {
            const characterStr = localStorage.getItem('character');
            if (!characterStr) return;

            const character = JSON.parse(characterStr);

            gameState.name = character.name;
            gameState.className = character.className;
            gameState.class = character.class;
            gameState.icon = character.icon;
            gameState.level = character.level;
            gameState.exp = character.exp;
            gameState.expToLevel = character.expToLevel;
            gameState.hp = character.hp;
            gameState.maxHp = character.maxHp;
            gameState.mp = character.mp;
            gameState.maxMp = character.maxMp;
            gameState.attack = character.attack;
            gameState.defense = character.defense;
            gameState.gold = character.gold;
            gameState.images = character.images;
        }

        // æˆ˜æ–—çŠ¶æ€
        let battleState = {
            active: false,
            monsterIndex: -1,
            turn: 'player',
            log: []
        };

        // å¼€å§‹æˆ˜æ–—
        function startBattle(monsterIndex) {
            const monster = gameState.monsters[monsterIndex];

            battleState.active = true;
            battleState.monsterIndex = monsterIndex;
            battleState.turn = 'player';
            battleState.log = [];

            addLog('--- æˆ˜æ–—å¼€å§‹ ---', 'info');
            addLog(`ä¸»è§’ VS ${monster.name}`, 'info');
        }

        // ç©å®¶æ”»å‡»
        function playerAttack() {
            if (!battleState.active || battleState.turn !== 'player') return;

            const monster = gameState.monsters[battleState.monsterIndex];
            const damage = Math.max(1, gameState.attack - monster.defense);

            monster.hp -= damage;
            addLog(`ä½ å¯¹ ${monster.name} é€ æˆ ${damage} ç‚¹ä¼¤å®³ï¼`, 'success');

            if (monster.hp <= 0) {
                battleVictory();
            } else {
                addLog(`${monster.name} å‰©ä½™ç”Ÿå‘½ï¼š${monster.hp}`, 'info');
                battleState.turn = 'monster';
                setTimeout(monsterAttack, 1000);
            }
        }

        // æ€ªç‰©æ”»å‡»
        function monsterAttack() {
            if (!battleState.active) return;

            const monster = gameState.monsters[battleState.monsterIndex];
            const damage = Math.max(1, monster.attack - gameState.defense);

            gameState.hp -= damage;
            addLog(`${monster.name} å¯¹ä½ é€ æˆ ${damage} ç‚¹ä¼¤å®³ï¼`, 'danger');

            if (gameState.hp <= 0) {
                gameState.hp = 0;
                battleDefeat();
            } else {
                addLog(`ä½ å‰©ä½™ç”Ÿå‘½ï¼š${gameState.hp}`, 'info');
                battleState.turn = 'player';
            }

            updateUI();
        }

        // æˆ˜æ–—èƒœåˆ©
        function battleVictory() {
            const monster = gameState.monsters[battleState.monsterIndex];

            addLog(`å‡»è´¥äº† ${monster.name}ï¼`, 'success');
            addLog(`è·å¾—ç»éªŒï¼š${monster.exp}ï¼Œé‡‘å¸ï¼š${monster.gold}`, 'success');

            gainExp(monster.exp);
            gainGold(monster.gold);

            // æ›´æ–°ä»»åŠ¡è¿›åº¦
            updateQuestProgress(monster.name);

            // æ›´æ–°å…³å¡è¿›åº¦
            const map = maps[gameState.currentMap];
            map.monstersDefeated++;
            checkLevelProgress();

            // ç§»é™¤æ€ªç‰©
            gameState.monsters.splice(battleState.monsterIndex, 1);
            battleState.active = false;
            battleState.monsterIndex = -1;

            addLog('--- æˆ˜æ–—ç»“æŸ ---', 'info');
            updateUI();
        }

        // æˆ˜æ–—å¤±è´¥
        function battleDefeat() {
            addLog('ä½ è¢«æ‰“è´¥äº†...', 'danger');
            addLog('ç”Ÿå‘½å€¼å·²æ¸…ç©ºï¼Œè¯·ä¼‘æ¯æ¢å¤', 'warning');

            battleState.active = false;
            battleState.monsterIndex = -1;

            addLog('--- æˆ˜æ–—ç»“æŸ ---', 'info');
        }

        // æ¢ç´¢
        function explore() {
            if (!gameState.started) return;

            if (gameState.hp <= gameState.maxHp * 0.2) {
                addLog('ç”Ÿå‘½å€¼è¿‡ä½ï¼Œè¯·å…ˆä¼‘æ¯æ¢å¤ï¼', 'danger');
                return;
            }

            if (battleState.active) {
                playerAttack();
                return;
            }

            if (gameState.monsters.length === 0) {
                addLog('å½“å‰åœ°å›¾æ²¡æœ‰æ€ªç‰©ï¼Œæ­£åœ¨ç”Ÿæˆæ–°æ€ªç‰©...', 'info');
                spawnMonsters();
                return;
            }

            // éšæœºé€‰æ‹©ä¸€ä¸ªæ€ªç‰©è¿›å…¥æˆ˜æ–—
            const monsterIndex = Math.floor(Math.random() * gameState.monsters.length);
            const monster = gameState.monsters[monsterIndex];

            addLog(`å‘ç°äº† ${monster.name}ï¼ˆLv.${monster.level}ï¼‰ï¼`, 'warning');
            addLog(`ç”Ÿå‘½ï¼š${monster.hp} | æ”»å‡»ï¼š${monster.attack} | é˜²å¾¡ï¼š${monster.defense}`, 'info');

            startBattle(monsterIndex);
        }

        // ä¼‘æ¯
        function rest() {
            if (!gameState.started) return;
            gameState.hp = gameState.maxHp;
            addLog('ä¼‘æ¯æ¢å¤ï¼Œç”Ÿå‘½å€¼å·²æ»¡', 'success');
            updateUI();
        }

        // æ‰“å¼€å•†åº—
        function openShop() {
            if (!gameState.started) return;
            showShopModal();
        }

        // èƒŒåŒ…
        const items = {
            // æ­¦å™¨
            'æœ¨å‰‘': { type: 'weapon', attack: 5, price: 50, quality: 'common' },
            'é“å‰‘': { type: 'weapon', attack: 15, price: 150, quality: 'uncommon' },
            'é’¢å‰‘': { type: 'weapon', attack: 30, price: 400, quality: 'rare' },
            'ç¥å‰‘': { type: 'weapon', attack: 60, price: 1000, quality: 'legendary' },
            // æŠ¤ç”²
            'å¸ƒç”²': { type: 'armor', defense: 5, price: 50, quality: 'common' },
            'é“ç”²': { type: 'armor', defense: 15, price: 150, quality: 'uncommon' },
            'é’¢ç”²': { type: 'armor', defense: 30, price: 400, quality: 'rare' },
            'ç¥ç”²': { type: 'armor', defense: 60, price: 1000, quality: 'legendary' },
            // é¥°å“
            'è‰æˆ’æŒ‡': { type: 'accessory', attack: 2, defense: 2, price: 80, quality: 'common' },
            'é“æˆ’æŒ‡': { type: 'accessory', attack: 6, defense: 6, price: 200, quality: 'uncommon' },
            'é‡‘æˆ’æŒ‡': { type: 'accessory', attack: 12, defense: 12, price: 500, quality: 'rare' },
            'ç¥æˆ’': { type: 'accessory', attack: 25, defense: 25, price: 1200, quality: 'legendary' }
        };

        // è£…å¤‡
        function equipItem(itemName) {
            const item = items[itemName];
            if (!item) return;

            // å¸ä¸‹å½“å‰è£…å¤‡
            const currentEquip = gameState.equipment[item.type];
            if (currentEquip) {
                gameState.inventory.push(currentEquip);
            }

            // è£…å¤‡æ–°ç‰©å“
            gameState.equipment[item.type] = itemName;

            // ä»èƒŒåŒ…ç§»é™¤
            const inventoryIndex = gameState.inventory.indexOf(itemName);
            if (inventoryIndex > -1) {
                gameState.inventory.splice(inventoryIndex, 1);
            }

            // æ›´æ–°å±æ€§
            updateStats();

            addLog(`è£…å¤‡äº† ${itemName}`, 'success');
            updateUI();
            saveGame();
            showInventoryModal();
        }

        // å¸ä¸‹è£…å¤‡
        function unequipItem(type) {
            const currentEquip = gameState.equipment[type];
            if (!currentEquip) return;

            gameState.inventory.push(currentEquip);
            gameState.equipment[type] = null;

            updateStats();
            addLog(`å¸ä¸‹äº† ${currentEquip}`, 'info');
            updateUI();
            saveGame();
            showInventoryModal();
        }

        // æ›´æ–°å±æ€§
        function updateStats() {
            // åŸºç¡€å±æ€§
            let baseAttack = 10 + (gameState.level - 1) * 5;
            let baseDefense = 5 + (gameState.level - 1) * 3;

            // è£…å¤‡åŠ æˆ
            Object.values(gameState.equipment).forEach(itemName => {
                if (itemName && items[itemName]) {
                    const item = items[itemName];
                    const enhancement = getEnhancementLevel(itemName);
                    if (item.attack) baseAttack += item.attack + item.attack * enhancement * 0.2;
                    if (item.defense) baseDefense += item.defense + item.defense * enhancement * 0.2;
                }
            });

            gameState.attack = Math.floor(baseAttack);
            gameState.defense = Math.floor(baseDefense);
        }

        // èƒŒåŒ…ç•Œé¢
        function openInventory() {
            if (!gameState.started) return;
            showInventoryModal();
        }

        // è´­ä¹°ç‰©å“
        function buyItem(itemName) {
            const item = items[itemName];
            if (!item) return;

            if (gameState.gold < item.price) {
                addLog('é‡‘å¸ä¸è¶³ï¼', 'danger');
                return;
            }

            gameState.gold -= item.price;
            gameState.inventory.push(itemName);

            addLog(`è´­ä¹°äº† ${itemName}`, 'success');
            updateUI();
            saveGame();
            showShopModal();
        }

        // æ˜¾ç¤ºå•†åº—å¼¹çª—
        function showShopModal() {
            const shopItems = Object.keys(items);
            let shopHTML = `
                <div id="shop-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 200;">
                    <div style="background: rgba(0,0,0,0.95); padding: 30px; border-radius: 15px; border: 2px solid rgba(255,255,255,0.2); max-width: 500px; max-height: 500px; overflow-y: auto;">
                        <h2 style="color: #f093fb; margin-bottom: 20px;">å•†åº—</h2>
                        <p style="color: #aaa; margin-bottom: 20px;">å½“å‰é‡‘å¸ï¼š${gameState.gold}</p>
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #4ecdc4; margin-bottom: 10px;">æ­¦å™¨</h3>
                            ${shopItems.filter(name => items[name].type === 'weapon').map(name => `
                                <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                    <div>
                                        <div style="color: #fff; font-weight: bold;">${name}</div>
                                        <div style="color: #aaa; font-size: 12px;">æ”»å‡» +${items[name].attack}</div>
                                    </div>
                                    <button class="btn" style="width: 80px;" onclick="buyItem('${name}')">${items[name].price}G</button>
                                </div>
                            `).join('')}
                        </div>
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #4ecdc4; margin-bottom: 10px;">æŠ¤ç”²</h3>
                            ${shopItems.filter(name => items[name].type === 'armor').map(name => `
                                <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                    <div>
                                        <div style="color: #fff; font-weight: bold;">${name}</div>
                                        <div style="color: #aaa; font-size: 12px;">é˜²å¾¡ +${items[name].defense}</div>
                                    </div>
                                    <button class="btn" style="width: 80px;" onclick="buyItem('${name}')">${items[name].price}G</button>
                                </div>
                            `).join('')}
                        </div>
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #4ecdc4; margin-bottom: 10px;">é¥°å“</h3>
                            ${shopItems.filter(name => items[name].type === 'accessory').map(name => `
                                <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                    <div>
                                        <div style="color: #fff; font-weight: bold;">${name}</div>
                                        <div style="color: #aaa; font-size: 12px;">æ”»+${items[name].attack} é˜²+${items[name].defense}</div>
                                    </div>
                                    <button class="btn" style="width: 80px;" onclick="buyItem('${name}')">${items[name].price}G</button>
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn" onclick="document.getElementById('shop-modal').remove()">å…³é—­</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', shopHTML);
        }

        // æ˜¾ç¤ºèƒŒåŒ…å¼¹çª—
        function showInventoryModal() {
            let inventoryHTML = `
                <div id="inventory-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 200;">
                    <div style="background: rgba(0,0,0,0.95); padding: 30px; border-radius: 15px; border: 2px solid rgba(255,255,255,0.2); max-width: 500px; max-height: 500px; overflow-y: auto;">
                        <h2 style="color: #f093fb; margin-bottom: 20px;">èƒŒåŒ…</h2>
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #4ecdc4; margin-bottom: 10px;">å·²è£…å¤‡</h3>
                            ${gameState.equipment.weapon ? `<div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;"><div style="color: #fff; font-weight: bold;">${gameState.equipment.weapon} (+${getEnhancementLevel(gameState.equipment.weapon)})</div><button class="btn" style="width: 80px; margin-top: 10px;" onclick="unequipItem('weapon')">å¸ä¸‹</button></div>` : '<div style="color: #aaa; margin: 10px 0;">ç©º</div>'}
                            ${gameState.equipment.armor ? `<div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;"><div style="color: #fff; font-weight: bold;">${gameState.equipment.armor} (+${getEnhancementLevel(gameState.equipment.armor)})</div><button class="btn" style="width: 80px; margin-top: 10px;" onclick="unequipItem('armor')">å¸ä¸‹</button></div>` : '<div style="color: #aaa; margin: 10px 0;">ç©º</div>'}
                            ${gameState.equipment.accessory ? `<div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;"><div style="color: #fff; font-weight: bold;">${gameState.equipment.accessory} (+${getEnhancementLevel(gameState.equipment.accessory)})</div><button class="btn" style="width: 80px; margin-top: 10px;" onclick="unequipItem('accessory')">å¸ä¸‹</button></div>` : '<div style="color: #aaa; margin: 10px 0;">ç©º</div>'}
                        </div>
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #4ecdc4; margin-bottom: 10px;">èƒŒåŒ…ç‰©å“</h3>
                            ${gameState.inventory.length > 0 ? gameState.inventory.map(name => `
                                <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                    <div>
                                        <div style="color: #fff; font-weight: bold;">${name}</div>
                                        <div style="color: #aaa; font-size: 12px;">${items[name].type === 'weapon' ? 'æ”»å‡»' : items[name].type === 'armor' ? 'é˜²å¾¡' : 'é¥°å“'} +${items[name].attack || items[name].defense}</div>
                                    </div>
                                    <button class="btn" style="width: 80px;" onclick="equipItem('${name}')">è£…å¤‡</button>
                                </div>
                            `).join('') : '<div style="color: #aaa; margin: 10px 0;">èƒŒåŒ…ä¸ºç©º</div>'}
                        </div>
                        <button class="btn" onclick="showCraftModal()">åˆæˆ</button>
                        <button class="btn" onclick="showEnhanceModal()">å¼ºåŒ–</button>
                        <button class="btn" onclick="showSkillModal()">æŠ€èƒ½</button>
                        <button class="btn" onclick="document.getElementById('inventory-modal').remove()">å…³é—­</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', inventoryHTML);
        }

        // åˆæˆé…æ–¹
        const recipes = {
            'é“å‰‘': ['æœ¨å‰‘', 'æœ¨å‰‘'],
            'é’¢å‰‘': ['é“å‰‘', 'é“å‰‘'],
            'ç¥å‰‘': ['é’¢å‰‘', 'é’¢å‰‘'],
            'é“ç”²': ['å¸ƒç”²', 'å¸ƒç”²'],
            'é’¢ç”²': ['é“ç”²', 'é“ç”²'],
            'ç¥ç”²': ['é’¢ç”²', 'é’¢ç”²'],
            'é“æˆ’æŒ‡': ['è‰æˆ’æŒ‡', 'è‰æˆ’æŒ‡'],
            'é‡‘æˆ’æŒ‡': ['é“æˆ’æŒ‡', 'é“æˆ’æŒ‡'],
            'ç¥æˆ’': ['é‡‘æˆ’æŒ‡', 'é‡‘æˆ’æŒ‡']
        };

        // åˆæˆè£…å¤‡
        function craftItem(resultItem) {
            const ingredients = recipes[resultItem];

            // æ£€æŸ¥ææ–™
            for (const ingredient of ingredients) {
                const index = gameState.inventory.indexOf(ingredient);
                if (index === -1) {
                    addLog('ææ–™ä¸è¶³ï¼', 'danger');
                    return;
                }
            }

            // ç§»é™¤ææ–™
            for (const ingredient of ingredients) {
                const index = gameState.inventory.indexOf(ingredient);
                gameState.inventory.splice(index, 1);
            }

            // æ·»åŠ ç»“æœ
            gameState.inventory.push(resultItem);

            addLog(`åˆæˆæˆåŠŸï¼è·å¾— ${resultItem}`, 'success');
            saveGame();
            showCraftModal();
        }

        // æ˜¾ç¤ºåˆæˆå¼¹çª—
        function showCraftModal() {
            let craftHTML = `
                <div id="craft-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 200;">
                    <div style="background: rgba(0,0,0,0.95); padding: 30px; border-radius: 15px; border: 2px solid rgba(255,255,255,0.2); max-width: 500px; max-height: 500px; overflow-y: auto;">
                        <h2 style="color: #f093fb; margin-bottom: 20px;">åˆæˆ</h2>
                        ${Object.keys(recipes).map(resultItem => `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div>
                                    <div style="color: #fff; font-weight: bold;">${resultItem}</div>
                                    <div style="color: #aaa; font-size: 12px;">ææ–™ï¼š${recipes[resultItem].join(' + ')}</div>
                                </div>
                                <button class="btn" style="width: 80px;" onclick="craftItem('${resultItem}')">åˆæˆ</button>
                            </div>
                        `).join('')}
                        <button class="btn" onclick="document.getElementById('craft-modal').remove(); showInventoryModal();">è¿”å›</button>
                    </div>
                </div>
            `;
            document.getElementById('inventory-modal').remove();
            document.body.insertAdjacentHTML('beforeend', craftHTML);
        }

        // è£…å¤‡å¼ºåŒ–
        const enhancements = {}; // è£…å¤‡å¼ºåŒ–ç­‰çº§

        function getEnhancementLevel(itemName) {
            return enhancements[itemName] || 0;
        }

        function enhanceItem(itemName) {
            const currentLevel = getEnhancementLevel(itemName);
            const cost = 100 * (currentLevel + 1);

            if (gameState.gold < cost) {
                addLog('é‡‘å¸ä¸è¶³ï¼', 'danger');
                return;
            }

            gameState.gold -= cost;
            enhancements[itemName] = currentLevel + 1;

            addLog(`${itemName} å¼ºåŒ–æˆåŠŸï¼å½“å‰ç­‰çº§ï¼š${enhancements[itemName]}`, 'success');
            updateStats();
            updateUI();
            saveGame();
            showEnhanceModal();
        }

        function showEnhanceModal() {
            let enhanceHTML = `
                <div id="enhance-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 200;">
                    <div style="background: rgba(0,0,0,0.95); padding: 30px; border-radius: 15px; border: 2px solid rgba(255,255,255,0.2); max-width: 500px; max-height: 500px; overflow-y: auto;">
                        <h2 style="color: #f093fb; margin-bottom: 20px;">å¼ºåŒ–</h2>
                        <p style="color: #aaa; margin-bottom: 20px;">å½“å‰é‡‘å¸ï¼š${gameState.gold}</p>
                        ${Object.keys(items).map(itemName => `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div>
                                    <div style="color: #fff; font-weight: bold;">${itemName} +${getEnhancementLevel(itemName)}</div>
                                    <div style="color: #aaa; font-size: 12px;">å¼ºåŒ–è´¹ç”¨ï¼š${100 * (getEnhancementLevel(itemName) + 1)}G</div>
                                </div>
                                <button class="btn" style="width: 80px;" onclick="enhanceItem('${itemName}')">å¼ºåŒ–</button>
                            </div>
                        `).join('')}
                        <button class="btn" onclick="document.getElementById('enhance-modal').remove()">å…³é—­</button>
                    </div>
                </div>
            `;
            document.getElementById('inventory-modal').remove();
            document.body.insertAdjacentHTML('beforeend', enhanceHTML);
        }

        // æŠ€èƒ½ç³»ç»Ÿ
        const skillData = {
            'ç«çƒæœ¯': { damage: 30, mpCost: 10, levelReq: 1, attackBonus: 20 },
            'å†°å†»æœ¯': { damage: 40, mpCost: 15, levelReq: 3, attackBonus: 30 },
            'é›·å‡»': { damage: 60, mpCost: 25, levelReq: 5, attackBonus: 50 },
            'æ²»æ„ˆæœ¯': { heal: 50, mpCost: 20, levelReq: 3, healBonus: 40 }
        };

        // NPC ç³»ç»Ÿ
        const npcData = {
            'æ–°æ‰‹æ‘': [
                {
                    name: 'æ‘é•¿',
                    avatar: 'ğŸ‘´',
                    dialogues: [
                        { text: 'å¹´è½»äººï¼Œæ¬¢è¿æ¥åˆ°æ–°æ‰‹æ‘ï¼è¿™é‡Œå¾ˆå®‰å…¨ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œç»ƒä¹ æˆ˜æ–—ã€‚', action: null },
                        { text: 'æƒ³å˜å¼ºçš„è¯ï¼Œå¤šå»æ‰“æ€ªå‡çº§å§ï¼', action: null },
                        { text: 'æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ', action: 'quest1' }
                    ],
                    quests: {
                        'quest1': {
                            title: 'åˆæ¬¡è¯•ç‚¼',
                            description: 'å‡»è´¥ 3 åªå²è±å§†',
                            target: 'å²è±å§†',
                            count: 3,
                            reward: { gold: 50, exp: 30 },
                            completed: false
                        }
                    }
                },
                {
                    name: 'å•†äºº',
                    avatar: 'ğŸ’°',
                    dialogues: [
                        { text: 'æƒ³è¦ä»€ä¹ˆè£…å¤‡ï¼Ÿæˆ‘çš„å•†åº—é‡Œåº”æœ‰å°½æœ‰ï¼', action: 'shop' }
                    ]
                }
            ],
            'æ£®æ—': [
                {
                    name: 'çŒäºº',
                    avatar: 'ğŸ¹',
                    dialogues: [
                        { text: 'å°å¿ƒæ£®æ—é‡Œçš„ç‹¼ç¾¤ï¼Œå®ƒä»¬å¾ˆå‡¶çŒ›ï¼', action: null },
                        { text: 'å¦‚æœä½ ç­‰çº§å¤Ÿé«˜ï¼Œå¯ä»¥æŒ‘æˆ˜æ£®æ—æ·±å¤„çš„æ€ªç‰©ã€‚', action: null }
                    ]
                }
            ],
            'å±±æ´': [
                {
                    name: 'å®ˆå¢“äºº',
                    avatar: 'âš°ï¸',
                    dialogues: [
                        { text: 'å±±æ´é‡ŒåŸ‹è—ç€å¤è€çš„ç§˜å¯†...', action: null },
                        { text: 'åªæœ‰æœ€å¼ºçš„äººæ‰èƒ½æ­å¼€çœŸç›¸ã€‚', action: null }
                    ]
                }
            ],
            'ä»™å±±': [
                {
                    name: 'ä»™å¸ˆ',
                    avatar: 'ğŸ§™',
                    dialogues: [
                        { text: 'å¹´è½»äººï¼Œä½ ç»ˆäºæ¥åˆ°äº†è¿™é‡Œã€‚', action: null },
                        { text: 'ä¿®ä»™ä¹‹è·¯æ¼«é•¿ï¼Œä½†ä½ çš„æ„å¿—å¾ˆåšå®šã€‚', action: null },
                        { text: 'ç»§ç»­åŠªåŠ›ï¼Œä½ ä¸€å®šèƒ½è¾¾åˆ°å·…å³°ï¼', action: null }
                    ]
                }
            ]
        };

        // ä»»åŠ¡ç³»ç»Ÿ
        let activeQuests = [];
        let completedQuests = [];

        // ä¸ NPC å¯¹è¯
        function talkToNPC() {
            if (!gameState.started) return;

            const npcs = npcData[gameState.currentMap];
            if (!npcs || npcs.length === 0) {
                addLog('å½“å‰åœ°å›¾æ²¡æœ‰ NPC', 'info');
                return;
            }

            showNPCModal(npcs);
        }

        // æ˜¾ç¤º NPC å¼¹çª—
        function showNPCModal(npcs) {
            let npcHTML = `
                <div id="npc-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 200;">
                    <div style="background: rgba(0,0,0,0.95); padding: 30px; border-radius: 15px; border: 2px solid rgba(255,255,255,0.2); max-width: 500px; max-height: 500px; overflow-y: auto;">
                        <h2 style="color: #f093fb; margin-bottom: 20px;">NPC åˆ—è¡¨</h2>
                        ${npcs.map(npc => `
                            <div style="margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                    <span style="font-size: 32px; margin-right: 10px;">${npc.avatar}</span>
                                    <div>
                                        <div style="color: #fff; font-weight: bold; font-size: 18px;">${npc.name}</div>
                                        <div style="color: #aaa; font-size: 12px;">ç‚¹å‡»å¯¹è¯</div>
                                    </div>
                                </div>
                                <button class="btn" onclick="showNPCDialogue('${npc.name}')">å¯¹è¯</button>
                            </div>
                        `).join('')}
                        <button class="btn" onclick="document.getElementById('npc-modal').remove()">å…³é—­</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', npcHTML);
        }

        // æ˜¾ç¤º NPC å¯¹è¯
        function showNPCDialogue(npcName) {
            const npcs = npcData[gameState.currentMap];
            const npc = npcs.find(n => n.name === npcName);

            if (!npc) return;

            document.getElementById('npc-modal').remove();

            let dialogueHTML = `
                <div id="dialogue-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 200;">
                    <div style="background: rgba(0,0,0,0.95); padding: 30px; border-radius: 15px; border: 2px solid rgba(255,255,255,0.2); max-width: 500px; max-height: 500px; overflow-y: auto;">
                        <div style="display: flex; align-items: center; margin-bottom: 20px;">
                            <span style="font-size: 48px; margin-right: 15px;">${npc.avatar}</span>
                            <div>
                                <h2 style="color: #f093fb; margin: 0;">${npc.name}</h2>
                            </div>
                        </div>
                        <div id="dialogue-container" style="margin-bottom: 20px;">
                            ${npc.dialogues.map((d, i) => `
                                <div style="margin: 10px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; cursor: pointer;" onclick="selectDialogue('${npc.name}', ${i}, '${d.action || ''}')">
                                    <div style="color: #fff; font-weight: bold;">${d.text}</div>
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn" onclick="document.getElementById('dialogue-modal').remove()">å…³é—­</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', dialogueHTML);
        }

        // é€‰æ‹©å¯¹è¯é€‰é¡¹
        function selectDialogue(npcName, dialogueIndex, action) {
            const npcs = npcData[gameState.currentMap];
            const npc = npcs.find(n => n.name === npcName);
            const dialogue = npc.dialogues[dialogueIndex];

            addLog(`${npc.name}: ${dialogue.text}`, 'info');

            // æ£€æŸ¥æ˜¯å¦æœ‰åŠ¨ä½œ
            if (action === 'shop') {
                document.getElementById('dialogue-modal').remove();
                showShopModal();
            } else if (action && npc.quests && npc.quests[action]) {
                // æ¥å—ä»»åŠ¡
                acceptQuest(npc.quests[action]);
            }

            // è®°å½•å¯¹è¯
            saveGame();
        }

        // æ¥å—ä»»åŠ¡
        function acceptQuest(quest) {
            const existingQuest = activeQuests.find(q => q.title === quest.title);
            if (existingQuest) {
                addLog('ä½ å·²ç»æ¥å–è¿‡è¿™ä¸ªä»»åŠ¡äº†ï¼', 'warning');
                return;
            }

            activeQuests.push({
                ...quest,
                currentCount: 0
            });

            addLog(`æ¥å–ä»»åŠ¡ï¼š${quest.title}`, 'success');
            addLog(quest.description, 'info');
            saveGame();
        }

        // æ›´æ–°ä»»åŠ¡è¿›åº¦
        function updateQuestProgress(monsterName) {
            activeQuests.forEach(quest => {
                if (quest.target === monsterName && quest.currentCount < quest.count) {
                    quest.currentCount++;

                    if (quest.currentCount >= quest.count) {
                        completeQuest(quest);
                    } else {
                        addLog(`ä»»åŠ¡è¿›åº¦ï¼š${quest.title} (${quest.currentCount}/${quest.count})`, 'info');
                    }
                }
            });
            saveGame();
        }

        // å®Œæˆä»»åŠ¡
        function completeQuest(quest) {
            addLog(`å®Œæˆä»»åŠ¡ï¼š${quest.title}ï¼`, 'success');
            addLog(`å¥–åŠ±ï¼šé‡‘å¸ ${quest.reward.gold}ï¼Œç»éªŒ ${quest.reward.exp}`, 'success');

            gainExp(quest.reward.exp);
            gainGold(quest.reward.gold);

            // ç§»é™¤å·²å®Œæˆä»»åŠ¡
            activeQuests = activeQuests.filter(q => q.title !== quest.title);
            completedQuests.push(quest.title);
            saveGame();
        }

        // æ˜¾ç¤ºä»»åŠ¡åˆ—è¡¨
        function showQuestModal() {
            let questHTML = `
                <div id="quest-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 200;">
                    <div style="background: rgba(0,0,0,0.95); padding: 30px; border-radius: 15px; border: 2px solid rgba(255,255,255,0.2); max-width: 500px; max-height: 500px; overflow-y: auto;">
                        <h2 style="color: #f093fb; margin-bottom: 20px;">ä»»åŠ¡</h2>
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #4ecdc4; margin-bottom: 10px;">è¿›è¡Œä¸­</h3>
                            ${activeQuests.length > 0 ? activeQuests.map(quest => `
                                <div style="margin: 10px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                    <div style="color: #fff; font-weight: bold;">${quest.title}</div>
                                    <div style="color: #aaa; font-size: 12px; margin: 5px 0;">${quest.description}</div>
                                    <div style="color: #fce38a; font-size: 12px;">è¿›åº¦ï¼š${quest.currentCount}/${quest.count}</div>
                                </div>
                            `).join('') : '<div style="color: #aaa; margin: 10px 0;">æ²¡æœ‰è¿›è¡Œä¸­çš„ä»»åŠ¡</div>'}
                        </div>
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #4ecdc4; margin-bottom: 10px;">å·²å®Œæˆ</h3>
                            ${completedQuests.length > 0 ? completedQuests.map(title => `
                                <div style="margin: 10px 0; padding: 10px; background: rgba(95, 231, 211, 0.1); border-radius: 8px;">
                                    <div style="color: #95e1d3; font-weight: bold;">${title}</div>
                                </div>
                            `).join('') : '<div style="color: #aaa; margin: 10px 0;">æ²¡æœ‰å·²å®Œæˆçš„ä»»åŠ¡</div>'}
                        </div>
                        <button class="btn" onclick="document.getElementById('quest-modal').remove()">å…³é—­</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', questHTML);
        }

        function learnSkill(skillName) {
            const skill = skillData[skillName];

            if (gameState.level < skill.levelReq) {
                addLog('ç­‰çº§ä¸è¶³ï¼', 'danger');
                return;
            }

            if (gameState.skills.includes(skillName)) {
                addLog('å·²ç»å­¦ä¼šäº†è¿™ä¸ªæŠ€èƒ½ï¼', 'warning');
                return;
            }

            gameState.skills.push(skillName);
            addLog(`å­¦ä¼šäº† ${skillName}ï¼`, 'success');
            saveGame();
            showSkillModal();
        }

        function useSkill(skillName) {
            if (!battleState.active || battleState.turn !== 'player') {
                addLog('åªèƒ½åœ¨æˆ˜æ–—ä¸­ä½¿ç”¨æŠ€èƒ½ï¼', 'danger');
                return;
            }

            const skill = skillData[skillName];

            if (skill.heal) {
                const healAmount = skill.heal + (gameState.level - 1) * skill.healBonus;
                gameState.hp = Math.min(gameState.maxHp, gameState.hp + healAmount);
                addLog(`ä½¿ç”¨ ${skillName}ï¼Œæ¢å¤ ${healAmount} ç”Ÿå‘½ï¼`, 'success');
            } else {
                const monster = gameState.monsters[battleState.monsterIndex];
                const damage = Math.max(1, (gameState.attack + skill.attackBonus) - monster.defense);

                monster.hp -= damage;
                addLog(`ä½¿ç”¨ ${skillName}ï¼Œå¯¹ ${monster.name} é€ æˆ ${damage} ç‚¹ä¼¤å®³ï¼`, 'success');

                if (monster.hp <= 0) {
                    battleVictory();
                    return;
                } else {
                    addLog(`${monster.name} å‰©ä½™ç”Ÿå‘½ï¼š${monster.hp}`, 'info');
                    battleState.turn = 'monster';
                    setTimeout(monsterAttack, 1000);
                }
            }

            updateUI();
        }

        function showSkillModal() {
            let skillHTML = `
                <div id="skill-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 200;">
                    <div style="background: rgba(0,0,0,0.95); padding: 30px; border-radius: 15px; border: 2px solid rgba(255,255,255,0.2); max-width: 500px; max-height: 500px; overflow-y: auto;">
                        <h2 style="color: #f093fb; margin-bottom: 20px;">æŠ€èƒ½</h2>
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #4ecdc4; margin-bottom: 10px;">å·²å­¦ä¼š</h3>
                            ${gameState.skills.length > 0 ? gameState.skills.map(skillName => `
                                <div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                    <div style="color: #fff; font-weight: bold;">${skillName}</div>
                                    <div style="color: #aaa; font-size: 12px;">${skillData[skillName].damage ? 'ä¼¤å®³' : 'æ²»ç–—'} +${skillData[skillName].damage || skillData[skillName].heal} | æ¶ˆè€— MP: ${skillData[skillName].mpCost}</div>
                                    ${battleState.active && battleState.turn === 'player' ? `<button class="btn" style="width: 80px; margin-top: 10px;" onclick="useSkill('${skillName}')">ä½¿ç”¨</button>` : ''}
                                </div>
                            `).join('') : '<div style="color: #aaa; margin: 10px 0;">æ²¡æœ‰å­¦ä¼šä»»ä½•æŠ€èƒ½</div>'}
                        </div>
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #4ecdc4; margin-bottom: 10px;">å¯å­¦ä¹ </h3>
                            ${Object.keys(skillData).filter(skillName => !gameState.skills.includes(skillName)).map(skillName => `
                                <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                    <div>
                                        <div style="color: #fff; font-weight: bold;">${skillName}</div>
                                        <div style="color: #aaa; font-size: 12px;">ç­‰çº§è¦æ±‚ï¼š${skillData[skillName].levelReq}</div>
                                    </div>
                                    ${gameState.level >= skillData[skillName].levelReq ? `<button class="btn" style="width: 80px;" onclick="learnSkill('${skillName}')">å­¦ä¹ </button>` : '<div style="color: #aaa;">ç­‰çº§ä¸è¶³</div>'}
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn" onclick="document.getElementById('skill-modal').remove()">å…³é—­</button>
                    </div>
                </div>
            `;
            document.getElementById('inventory-modal').remove();
            document.body.insertAdjacentHTML('beforeend', skillHTML);
        }

        // è§’è‰²å‡çº§
        function levelUp() {
            if (gameState.exp >= gameState.expToLevel) {
                gameState.level++;
                gameState.exp -= gameState.expToLevel;
                gameState.expToLevel = Math.floor(gameState.expToLevel * 1.5);

                // æå‡å±æ€§
                gameState.maxHp += 20;
                gameState.hp = gameState.maxHp;
                gameState.attack += 5;
                gameState.defense += 3;

                addLog(`æ­å–œå‡çº§ï¼å½“å‰ç­‰çº§ï¼š${gameState.level}`, 'success');
                addLog(`ç”Ÿå‘½å€¼+20ï¼Œæ”»å‡»åŠ›+5ï¼Œé˜²å¾¡åŠ›+3`, 'info');
                updateUI();
                saveGame();
            }
        }

        // è·å¾—ç»éªŒ
        function gainExp(amount) {
            gameState.exp += amount;
            addLog(`è·å¾—ç»éªŒï¼š${amount}`, 'info');

            if (gameState.exp >= gameState.expToLevel) {
                levelUp();
            }

            updateUI();
            saveGame();
        }

        // è·å¾—é‡‘å¸
        function gainGold(amount) {
            gameState.gold += amount;
            addLog(`è·å¾—é‡‘å¸ï¼š${amount}`, 'success');
            updateUI();
            saveGame();
        }

        // å­˜æ¡£
        function saveGame() {
            const saveData = {
                ...gameState,
                activeQuests,
                completedQuests
            };
            localStorage.setItem('immortalGame', JSON.stringify(saveData));
        }

        // è¯»æ¡£
        function loadGame() {
            const savedData = localStorage.getItem('immortalGame');
            if (savedData) {
                const loadedState = JSON.parse(savedData);

                // æ¢å¤æ¸¸æˆçŠ¶æ€
                gameState = {
                    ...gameState,
                    ...loadedState
                };

                // æ¢å¤ä»»åŠ¡ç³»ç»Ÿ
                if (loadedState.activeQuests) activeQuests = loadedState.activeQuests;
                if (loadedState.completedQuests) completedQuests = loadedState.completedQuests;

                return true;
            }
            return false;
        }

        // åˆå§‹åŒ–
        function init() {
            // å°è¯•åŠ è½½å­˜æ¡£
            if (loadGame()) {
                document.getElementById('start-screen').style.display = 'none';
                gameState.started = true;
                addLog('æ¬¢è¿å›æ¥ï¼Œä¿®ä»™è€…ï¼', 'success');
                updateUI();
                gameLoop();
            } else {
                updateUI();
            }
        }

        init();
    </script>
</body>
</html>

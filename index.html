<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¿®ä»™æ¸¸æˆ - AI Native</title>
  <style>
    /* ==================== åŸºç¡€æ ·å¼ ==================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft YaHei', 'SimSun', sans-serif;
      overflow: hidden;
      background: #1a1a2e;
      color: #e0e0e0;
    }

    /* ==================== æ¸¸æˆå®¹å™¨ ==================== */
    #game-container {
      width: 100vw;
      height: 100vh;
      position: relative;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    }

    /* ==================== æ¸¸æˆç”»å¸ƒ ==================== */
    #game-canvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    /* ==================== UI å±‚ ==================== */
    .ui-layer {
      position: absolute;
      pointer-events: none;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
    }

    .ui-layer > * {
      pointer-events: auto;
    }

    /* ==================== é¡¶éƒ¨çŠ¶æ€æ  ==================== */
    .status-bar {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 10px;
      border: 1px solid rgba(244, 208, 63, 0.3);
    }

    .status-left {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .status-right {
      display: flex;
      gap: 10px;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
    }

    .status-label {
      color: #f4d03f;
      font-weight: bold;
    }

    .status-value {
      color: #fff;
    }

    /* ==================== è¡€æ¡å’Œç»éªŒæ¡ ==================== */
    .bar-container {
      display: flex;
      flex-direction: column;
      gap: 5px;
      min-width: 150px;
    }

    .bar {
      height: 8px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 4px;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    .hp-bar .bar-fill {
      background: linear-gradient(90deg, #c0392b, #e74c3c);
    }

    .exp-bar .bar-fill {
      background: linear-gradient(90deg, #2980b9, #3498db);
    }

    .bar-text {
      font-size: 12px;
      color: #f4d03f;
    }

    /* ==================== åº•éƒ¨æŒ‰é’®æ  ==================== */
    .button-bar {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 10px;
      border: 1px solid rgba(244, 208, 63, 0.3);
    }

    .game-btn {
      background: linear-gradient(135deg, #f4d03f 0%, #16a085 100%);
      color: #1a1a2e;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .game-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
    }

    .game-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* ==================== æ¨¡æ€æ¡† ==================== */
    .modal {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(26, 26, 46, 0.95);
      border-radius: 15px;
      border: 2px solid rgba(244, 208, 63, 0.5);
      padding: 30px;
      min-width: 400px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      display: none;
      z-index: 1000;
    }

    .modal.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(244, 208, 63, 0.3);
    }

    .modal-title {
      font-size: 24px;
      font-weight: bold;
      color: #f4d03f;
    }

    .modal-close {
      background: #c0392b;
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: #e74c3c;
      transform: rotate(90deg);
    }

    .modal-content {
      max-height: 60vh;
      overflow-y: auto;
    }

    /* ==================== è§’è‰²é¢æ¿ ==================== */
    .character-panel {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .character-section {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 10px;
      border: 1px solid rgba(244, 208, 63, 0.2);
    }

    .character-section h3 {
      color: #f4d03f;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(244, 208, 63, 0.1);
    }

    .stat-label {
      color: #f4d03f;
    }

    .stat-value {
      color: #fff;
      font-weight: bold;
    }

    /* ==================== å¯¹è¯æ¡† ==================== */
    .dialog-box {
      background: rgba(255, 255, 255, 0.95);
      color: #1a1a2e;
      padding: 20px;
      border-radius: 10px;
      border: 2px solid #f4d03f;
      max-width: 500px;
    }

    .dialog-npc {
      font-weight: bold;
      color: #f4d03f;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .dialog-text {
      margin-bottom: 15px;
      line-height: 1.6;
    }

    .dialog-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .dialog-option {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      text-align: left;
      transition: all 0.3s ease;
    }

    .dialog-option:hover {
      background: linear-gradient(135deg, #5dade2, #3498db);
      transform: translateX(5px);
    }

    /* ==================== æ¶ˆæ¯æç¤º ==================== */
    .toast {
      position: absolute;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: #f4d03f;
      padding: 15px 30px;
      border-radius: 10px;
      border: 1px solid rgba(244, 208, 63, 0.5);
      font-size: 16px;
      font-weight: bold;
      z-index: 1000;
      display: none;
      animation: slideDown 0.3s ease;
    }

    .toast.show {
      display: block;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    /* ==================== è§’è‰²åˆ›å»ºç•Œé¢ ==================== */

    .character-creation-screen {
      position: absolute;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .creation-container {
      width: 900px;
      max-width: 95%;
      background: rgba(0, 0, 0, 0.85);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      border: 2px solid rgba(102, 126, 234, 0.3);
    }

    .creation-title {
      font-size: 36px;
      text-align: center;
      margin-bottom: 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .creation-section {
      margin-bottom: 30px;
    }

    .section-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #f093fb;
      border-bottom: 2px solid rgba(240, 147, 251, 0.3);
      padding-bottom: 8px;
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: #aaa;
    }

    .input-group input[type="text"] {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: #fff;
      transition: all 0.3s;
    }

    .input-group input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
      background: rgba(255, 255, 255, 0.08);
    }

    .error-message {
      color: #f38181;
      font-size: 14px;
      margin-top: 5px;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    .class-selection {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }

    .class-card {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .class-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    .class-card.selected {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
    }

    .class-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .class-name {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #fff;
    }

    .class-description {
      font-size: 12px;
      color: #aaa;
      line-height: 1.5;
    }

    .class-stats {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .class-stats .stat {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
      font-size: 13px;
      color: #4ecdc4;
    }

    .preview-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 20px;
    }

    .character-preview {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 20px;
    }

    .preview-image {
      width: 100%;
      height: 200px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 80px;
      margin-bottom: 20px;
      transition: all 0.3s;
    }

    .preview-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .action-preview {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .action-preview:hover {
      border-color: #667eea;
    }

    .action-preview.active {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
    }

    .action-icon {
      font-size: 32px;
      margin-bottom: 5px;
    }

    .action-name {
      font-size: 12px;
      color: #aaa;
    }

    .action-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
      display: none;
      margin-top: 10px;
    }

    .action-preview.active .action-image {
      display: block;
    }

    .character-info {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 20px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      font-size: 16px;
    }

    .info-label {
      color: #aaa;
    }

    .info-value {
      color: #4ecdc4;
      font-weight: bold;
    }

    .creation-actions {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }

    .creation-actions .btn {
      flex: 1;
      padding: 15px 30px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .creation-actions .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .creation-actions .btn.primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }

    .creation-actions .btn.primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .creation-actions .btn.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .creation-actions .btn.secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* ==================== åŠ è½½ç•Œé¢ ==================== */
    .loading-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .loading-title {
      font-size: 48px;
      font-weight: bold;
      color: #f4d03f;
      margin-bottom: 30px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    .loading-bar {
      width: 300px;
      height: 10px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 5px;
      overflow: hidden;
    }

    .loading-progress {
      height: 100%;
      background: linear-gradient(90deg, #f4d03f, #16a085);
      width: 0%;
      transition: width 0.3s ease;
    }

    .loading-text {
      margin-top: 20px;
      color: #f4d03f;
      font-size: 18px;
    }

    /* ==================== æ»šåŠ¨æ¡æ ·å¼ ==================== */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(244, 208, 63, 0.5);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(244, 208, 63, 0.8);
    }

    /* ==================== å“åº”å¼è®¾è®¡ ==================== */
    @media (max-width: 768px) {
      .status-bar {
        flex-direction: column;
        gap: 10px;
      }

      .status-left {
        flex-wrap: wrap;
      }

      .button-bar {
        width: 90%;
        flex-wrap: wrap;
        justify-content: center;
      }

      .modal {
        width: 90%;
        min-width: auto;
      }

      .character-panel {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- æ¸¸æˆå®¹å™¨ -->
  <div id="game-container">
    <!-- æ¸¸æˆç”»å¸ƒ -->
    <canvas id="game-canvas"></canvas>

    <!-- UI å±‚ -->
    <div class="ui-layer">
      <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
      <div class="status-bar" id="status-bar" style="display: none;">
        <div class="status-left">
          <div class="bar-container">
            <div class="bar hp-bar">
              <div class="bar-fill" id="hp-bar-fill" style="width: 100%;"></div>
            </div>
            <div class="bar-text" id="hp-bar-text">HP: 100/100</div>
          </div>
          <div class="bar-container">
            <div class="bar exp-bar">
              <div class="bar-fill" id="exp-bar-fill" style="width: 0%;"></div>
            </div>
            <div class="bar-text" id="exp-bar-text">EXP: 0/100</div>
          </div>
          <div class="status-item">
            <span class="status-label">ç­‰çº§:</span>
            <span class="status-value" id="level-value">1</span>
          </div>
          <div class="status-item">
            <span class="status-label">é‡‘å¸:</span>
            <span class="status-value" id="gold-value">0</span>
          </div>
        </div>
        <div class="status-right">
          <div class="status-item">
            <span class="status-label">åœ°å›¾:</span>
            <span class="status-value" id="map-value">æ‘åº„</span>
          </div>
        </div>
      </div>

      <!-- åº•éƒ¨æŒ‰é’®æ  -->
      <div class="button-bar" id="button-bar" style="display: none;">
        <button class="game-btn" onclick="openCharacterPanel()">ğŸ‘¤ è§’è‰²</button>
        <button class="game-btn" onclick="openInventoryPanel()">ğŸ’ èƒŒåŒ…</button>
        <button class="game-btn" onclick="openSkillsPanel()">âš”ï¸ æŠ€èƒ½</button>
        <button class="game-btn" onclick="openTasksPanel()">ğŸ“‹ ä»»åŠ¡</button>
        <button class="game-btn" onclick="saveGame()">ğŸ’¾ ä¿å­˜</button>
      </div>

      <!-- æ¶ˆæ¯æç¤º -->
      <div class="toast" id="toast"></div>
    </div>

    <!-- è§’è‰²é¢æ¿æ¨¡æ€æ¡† -->
    <div class="modal" id="character-modal">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ‘¤ è§’è‰²ä¿¡æ¯</h2>
        <button class="modal-close" onclick="closeModal('character-modal')">&times;</button>
      </div>
      <div class="modal-content">
        <div class="character-panel" id="character-content">
          <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>

    <!-- èƒŒåŒ…é¢æ¿æ¨¡æ€æ¡† -->
    <div class="modal" id="inventory-modal">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ’ èƒŒåŒ…</h2>
        <button class="modal-close" onclick="closeModal('inventory-modal')">&times;</button>
      </div>
      <div class="modal-content" id="inventory-content">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>

    <!-- æŠ€èƒ½é¢æ¿æ¨¡æ€æ¡† -->
    <div class="modal" id="skills-modal">
      <div class="modal-header">
        <h2 class="modal-title">âš”ï¸ æŠ€èƒ½</h2>
        <button class="modal-close" onclick="closeModal('skills-modal')">&times;</button>
      </div>
      <div class="modal-content" id="skills-content">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>

    <!-- ä»»åŠ¡é¢æ¿æ¨¡æ€æ¡† -->
    <div class="modal" id="tasks-modal">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“‹ ä»»åŠ¡</h2>
        <button class="modal-close" onclick="closeModal('tasks-modal')">&times;</button>
      </div>
      <div class="modal-content" id="tasks-content">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>

    <!-- å¯¹è¯æ¡†æ¨¡æ€æ¡† -->
    <div class="modal" id="dialog-modal">
      <div class="dialog-box">
        <div class="dialog-npc" id="dialog-npc">NPC åå­—</div>
        <div class="dialog-text" id="dialog-text">å¯¹è¯å†…å®¹</div>
        <div class="dialog-options" id="dialog-options">
          <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>

    <!-- åŠ è½½ç•Œé¢ -->
    <div class="loading-screen" id="loading-screen">
      <h1 class="loading-title">ä¿®ä»™æ¸¸æˆ</h1>
      <div class="loading-bar">
        <div class="loading-progress" id="loading-progress"></div>
      </div>
      <div class="loading-text" id="loading-text">åŠ è½½ä¸­...</div>
    </div>

    <!-- è§’è‰²åˆ›å»ºç•Œé¢ -->
    <div class="character-creation-screen" id="character-creation-screen" style="display: none;">
      <div class="creation-container">
        <h1 class="creation-title">è§’è‰²åˆ›å»º</h1>

        <div class="creation-section">
          <div class="section-title">è§’è‰²åå­—</div>
          <div class="input-group">
            <label for="character-name">è¾“å…¥ä½ çš„åå­—</label>
            <input type="text" id="character-name" placeholder="è¯·è¾“å…¥è§’è‰²åå­—ï¼ˆ2-10ä¸ªå­—ç¬¦ï¼‰" maxlength="10">
            <div class="error-message" id="name-error">è¯·è¾“å…¥æœ‰æ•ˆçš„è§’è‰²åå­—</div>
          </div>
        </div>

        <div class="creation-section">
          <div class="section-title">é€‰æ‹©èŒä¸š</div>
          <div class="class-selection">
            <div class="class-card" data-class="swordsman" onclick="selectClass('swordsman')">
              <div class="class-icon">âš”ï¸</div>
              <div class="class-name">å‰‘ä¿®</div>
              <div class="class-description">ä»¥å‰‘å…¥é“ï¼Œæ”»å®ˆå…¼å¤‡ï¼Œæ“…é•¿è¿‘æˆ˜æ”»å‡»</div>
              <div class="class-stats">
                <div class="stat"><span>æ”»å‡»</span><span>â˜…â˜…â˜…â˜…â˜…</span></div>
                <div class="stat"><span>é˜²å¾¡</span><span>â˜…â˜…â˜…â˜…â˜†</span></div>
                <div class="stat"><span>ç”Ÿå‘½</span><span>â˜…â˜…â˜…â˜†â˜†</span></div>
              </div>
            </div>

            <div class="class-card" data-class="mage" onclick="selectClass('mage')">
              <div class="class-icon">ğŸ”®</div>
              <div class="class-name">æ³•ä¿®</div>
              <div class="class-description">æ³•åŠ›æ— è¾¹ï¼ŒæŒæ§å…ƒç´ ï¼Œæ“…é•¿è¿œç¨‹æ³•æœ¯</div>
              <div class="class-stats">
                <div class="stat"><span>æ”»å‡»</span><span>â˜…â˜…â˜…â˜…â˜†</span></div>
                <div class="stat"><span>é˜²å¾¡</span><span>â˜…â˜…â˜†â˜†â˜†</span></div>
                <div class="stat"><span>ç”Ÿå‘½</span><span>â˜…â˜…â˜…â˜…â˜†</span></div>
              </div>
            </div>

            <div class="class-card" data-class="warrior" onclick="selectClass('warrior')">
              <div class="class-icon">ğŸ’ª</div>
              <div class="class-name">ä½“ä¿®</div>
              <div class="class-description">è‚‰èº«æˆåœ£ï¼ŒåšéŸ§ä¸æ‹”ï¼Œæ“…é•¿æŒä¹…æˆ˜æ–—</div>
              <div class="class-stats">
                <div class="stat"><span>æ”»å‡»</span><span>â˜…â˜…â˜…â˜†â˜†</span></div>
                <div class="stat"><span>é˜²å¾¡</span><span>â˜…â˜…â˜…â˜…â˜…</span></div>
                <div class="stat"><span>ç”Ÿå‘½</span><span>â˜…â˜…â˜…â˜…â˜…</span></div>
              </div>
            </div>
          </div>
        </div>

        <div class="creation-section">
          <div class="section-title">è§’è‰²é¢„è§ˆ</div>
          <div class="preview-section">
            <div class="character-preview">
              <div class="preview-image" id="main-preview">
                <span id="preview-icon">âš”ï¸</span>
              </div>
              <div class="preview-actions">
                <div class="action-preview" data-action="idle" onclick="previewAction('idle')">
                  <div class="action-icon">ğŸ§</div>
                  <div class="action-name">ç«™ç«‹</div>
                  <img class="action-image" id="idle-image">
                </div>
                <div class="action-preview" data-action="attack" onclick="previewAction('attack')">
                  <div class="action-icon">âš”ï¸</div>
                  <div class="action-name">æ”»å‡»</div>
                  <img class="action-image" id="attack-image">
                </div>
                <div class="action-preview" data-action="injured" onclick="previewAction('injured')">
                  <div class="action-icon">ğŸ’¥</div>
                  <div class="action-name">å—ä¼¤</div>
                  <img class="action-image" id="injured-image">
                </div>
                <div class="action-preview" data-action="victory" onclick="previewAction('victory')">
                  <div class="action-icon">ğŸ†</div>
                  <div class="action-name">èƒœåˆ©</div>
                  <img class="action-image" id="victory-image">
                </div>
              </div>
            </div>

            <div class="character-info">
              <div class="info-row">
                <span class="info-label">åå­—:</span>
                <span class="info-value" id="info-name">æœªå‘½å</span>
              </div>
              <div class="info-row">
                <span class="info-label">èŒä¸š:</span>
                <span class="info-value" id="info-class">æœªé€‰æ‹©</span>
              </div>
              <div class="info-row">
                <span class="info-label">æ”»å‡»:</span>
                <span class="info-value" id="info-attack">-</span>
              </div>
              <div class="info-row">
                <span class="info-label">é˜²å¾¡:</span>
                <span class="info-value" id="info-defense">-</span>
              </div>
              <div class="info-row">
                <span class="info-label">ç”Ÿå‘½:</span>
                <span class="info-value" id="info-hp">-</span>
              </div>
              <div class="info-row">
                <span class="info-label">æ³•åŠ›:</span>
                <span class="info-value" id="info-mp">-</span>
              </div>
            </div>
          </div>
        </div>

        <div class="creation-actions">
          <button class="btn secondary" onclick="goBack()">è¿”å›</button>
          <button class="btn primary" id="create-btn" onclick="createCharacter()" disabled>åˆ›å»ºè§’è‰²</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import coordinatorAPI from './js/coordinator-api.js';
    import { MAP_DATA } from './js/map-system.js';
    import { NPC_DATA } from './js/npc-agent.js';
    import { MONSTER_DATA } from './js/battle-agent.js';

    // å…¨å±€å˜é‡
    let gameState = null;
    let canvas = null;
    let ctx = null;

    // è§’è‰²åˆ›å»ºç›¸å…³å˜é‡
    let currentName = '';
    let currentClass = null;
    let characterImages = {};
    const classData = {
      swordsman: {
        name: 'å‰‘ä¿®',
        icon: 'âš”ï¸',
        baseAttack: 15,
        baseDefense: 10,
        baseHp: 100,
        baseMp: 50
      },
      mage: {
        name: 'æ³•ä¿®',
        icon: 'ğŸ”®',
        baseAttack: 12,
        baseDefense: 5,
        baseHp: 80,
        baseMp: 100
      },
      warrior: {
        name: 'ä½“ä¿®',
        icon: 'ğŸ’ª',
        baseAttack: 10,
        baseDefense: 15,
        baseHp: 120,
        baseMp: 30
      }
    };

    // åˆå§‹åŒ–æ¸¸æˆ
    async function initGame() {
      try {
        // æ£€æŸ¥æ˜¯å¦æœ‰è§’è‰²
        const savedCharacter = localStorage.getItem('character');

        if (!savedCharacter) {
          // æ²¡æœ‰è§’è‰²ï¼Œæ˜¾ç¤ºè§’è‰²åˆ›å»ºç•Œé¢
          document.getElementById('loading-screen').style.display = 'none';
          document.getElementById('character-creation-screen').style.display = 'flex';
          return;
        }

        // æœ‰è§’è‰²ï¼ŒåŠ è½½è§’è‰²æ•°æ®
        showLoading('åˆå§‹åŒ–æ¸¸æˆ...', 10);

        // åˆå§‹åŒ–åè°ƒ Agent
        gameState = await coordinatorAPI.initGame();

        // åŠ è½½è§’è‰²æ•°æ®
        const character = JSON.parse(savedCharacter);
        gameState.player = {
          ...gameState.player,
          ...character
        };

        showLoading('åŠ è½½èµ„æº...', 30);

        // åˆå§‹åŒ–ç”»å¸ƒ
        canvas = document.getElementById('game-canvas');
        ctx = canvas.getContext('2d');
        resizeCanvas();

        showLoading('å‡†å¤‡æ¸¸æˆ...', 60);

        // æ˜¾ç¤º UI
        document.getElementById('status-bar').style.display = 'flex';
        document.getElementById('button-bar').style.display = 'flex';

        // æ›´æ–° UI
        updateUI();

        showLoading('å®Œæˆ!', 100);

        // éšè—åŠ è½½ç•Œé¢
        setTimeout(() => {
          hideLoading();
        }, 500);

        // å¼€å§‹æ¸¸æˆå¾ªç¯
        gameLoop();
      } catch (error) {
        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        showToast('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
      }
    }

    // ==================== è§’è‰²åˆ›å»ºç›¸å…³å‡½æ•° ====================

    // é€‰æ‹©èŒä¸š
    window.selectClass = function(className) {
      // ç§»é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.class-card').forEach(card => {
        card.classList.remove('selected');
      });

      // æ·»åŠ æ–°çš„é€‰ä¸­çŠ¶æ€
      document.querySelector(`[data-class="${className}"]`).classList.add('selected');

      currentClass = className;
      const classInfo = classData[className];

      // æ›´æ–°é¢„è§ˆ
      document.getElementById('preview-icon').textContent = classInfo.icon;
      document.getElementById('info-class').textContent = classInfo.name;
      document.getElementById('info-attack').textContent = classInfo.baseAttack;
      document.getElementById('info-defense').textContent = classInfo.baseDefense;
      document.getElementById('info-hp').textContent = classInfo.baseHp;
      document.getElementById('info-mp').textContent = classInfo.baseMp;

      updateCreateButton();
    };

    // è¾“å…¥åå­—
    document.addEventListener('DOMContentLoaded', () => {
      const nameInput = document.getElementById('character-name');
      if (nameInput) {
        nameInput.addEventListener('input', function(e) {
          currentName = e.target.value.trim();
          document.getElementById('info-name').textContent = currentName || 'æœªå‘½å';
          updateCreateButton();
        });
      }
    });

    // æ›´æ–°åˆ›å»ºæŒ‰é’®çŠ¶æ€
    function updateCreateButton() {
      const btn = document.getElementById('create-btn');
      const nameError = document.getElementById('name-error');

      // éªŒè¯åå­—
      if (currentName.length < 2 || currentName.length > 10) {
        nameError.classList.add('show');
        btn.disabled = true;
        return;
      } else {
        nameError.classList.remove('show');
      }

      // éªŒè¯èŒä¸š
      if (!currentClass) {
        btn.disabled = true;
        return;
      }

      btn.disabled = false;
    }

    // é¢„è§ˆåŠ¨ä½œ
    window.previewAction = function(action) {
      // ç§»é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.action-preview').forEach(card => {
        card.classList.remove('active');
      });

      // æ·»åŠ æ–°çš„é€‰ä¸­çŠ¶æ€
      document.querySelector(`[data-action="${action}"]`).classList.add('active');

      // æ›´æ–°ä¸»é¢„è§ˆ
      const mainPreview = document.getElementById('main-preview');
      const previewIcon = document.getElementById('preview-icon');

      if (characterImages[action]) {
        mainPreview.innerHTML = `<img src="${characterImages[action]}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">`;
      } else {
        mainPreview.innerHTML = `<span>${previewIcon.textContent}</span>`;
      }
    };

    // åˆ›å»ºè§’è‰²
    window.createCharacter = async function() {
      try {
        const classInfo = classData[currentClass];

        // ç”Ÿæˆè§’è‰²æ•°æ®
        const character = {
          name: currentName,
          class: currentClass,
          className: classInfo.name,
          icon: classInfo.icon,
          baseAttack: classInfo.baseAttack,
          baseDefense: classInfo.baseDefense,
          baseHp: classInfo.baseHp,
          baseMp: classInfo.baseMp,
          level: 1,
          exp: 0,
          expToLevel: 100,
          hp: classInfo.baseHp,
          maxHp: classInfo.baseHp,
          mp: classInfo.baseMp,
          maxMp: classInfo.baseMp,
          attack: classInfo.baseAttack,
          defense: classInfo.baseDefense,
          gold: 100,
          images: characterImages,
          createdAt: new Date().toISOString()
        };

        // ä¿å­˜è§’è‰²æ•°æ®
        localStorage.setItem('character', JSON.stringify(character));

        // éšè—è§’è‰²åˆ›å»ºç•Œé¢
        document.getElementById('character-creation-screen').style.display = 'none';

        // é‡æ–°åˆå§‹åŒ–æ¸¸æˆ
        await initGame();
      } catch (error) {
        console.error('åˆ›å»ºè§’è‰²å¤±è´¥:', error);
        alert('åˆ›å»ºè§’è‰²å¤±è´¥: ' + error.message);
      }
    };

    // è¿”å›
    window.goBack = function() {
      window.location.href = 'character-creation.html';
    };

    // è°ƒæ•´ç”»å¸ƒå¤§å°
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }

    // æ¸¸æˆå¾ªç¯
    function gameLoop() {
      update();
      render();
      requestAnimationFrame(gameLoop);
    }

    // æ›´æ–°é€»è¾‘
    function update() {
      if (!gameState) return;

      // æ£€æŸ¥æ˜¯å¦åœ¨æˆ˜æ–—ä¸­
      if (gameState.gamePhase === 'battle') {
        // æˆ˜æ–—é€»è¾‘åœ¨ battle ç³»ç»Ÿä¸­å¤„ç†
        return;
      }

      // æ£€æŸ¥æ˜¯å¦åœ¨å¯¹è¯ä¸­
      if (gameState.gamePhase === 'dialog') {
        // å¯¹è¯é€»è¾‘åœ¨ NPC ç³»ç»Ÿä¸­å¤„ç†
        return;
      }
    }

    // æ¸²æŸ“
    function render() {
      if (!gameState) return;

      // æ¸…ç©ºç”»å¸ƒ
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // æ ¹æ®æ¸¸æˆé˜¶æ®µæ¸²æŸ“ä¸åŒå†…å®¹
      if (gameState.gamePhase === 'battle') {
        renderBattle();
      } else if (gameState.gamePhase === 'dialog') {
        renderScene(); // æ¸²æŸ“èƒŒæ™¯åœºæ™¯
        renderDialog(); // æ¸²æŸ“å¯¹è¯æ¡†
      } else {
        renderScene(); // æ­£å¸¸æ¸¸æˆåœºæ™¯
      }
    }

    // æ¸²æŸ“åœºæ™¯
    function renderScene() {
      if (!gameState) return;

      // ç»˜åˆ¶èƒŒæ™¯
      ctx.fillStyle = '#1a1a2e';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // ç»˜åˆ¶åœ°å›¾ä¿¡æ¯
      const currentMapId = gameState.currentMap;
      if (!currentMapId) return;

      // TODO: åŠ è½½åœ°å›¾èƒŒæ™¯å›¾ç‰‡
      // ç›®å‰ä½¿ç”¨çº¯è‰²èƒŒæ™¯
      const mapColors = {
        'village': '#2d5a27', // ç»¿è‰²
        'forest': '#1a3d0e', // æ·±ç»¿
        'cave': '#3d3d3d', // ç°è‰²
        'desert': '#c2b280', // æ²™è‰²
        'snow': '#e6e6e6', // ç™½è‰²
        'volcano': '#4a1c1c', // æš—çº¢
        'demon_palace': '#1a1a2e' // æ·±è“
      };
      ctx.fillStyle = mapColors[currentMapId] || '#1a1a2e';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // ç»˜åˆ¶åœ°å›¾åç§°
      ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
      ctx.font = 'bold 24px Microsoft YaHei';
      ctx.textAlign = 'center';
      const mapNames = {
        'village': 'æ–°æ‰‹æ‘',
        'forest': 'æ£®æ—',
        'cave': 'å±±æ´',
        'desert': 'æ²™æ¼ ',
        'snow': 'å†°åŸ',
        'volcano': 'ç«å±±',
        'demon_palace': 'é­”å®«'
      };
      ctx.fillText(mapNames[currentMapId] || currentMapId, canvas.width / 2, 50);

      // ç»˜åˆ¶ç©å®¶ä½ç½®
      if (gameState.player && gameState.player.position) {
        const pos = gameState.player.position;

        // ç»˜åˆ¶ç©å®¶
        ctx.beginPath();
        ctx.arc(pos.x, pos.y, 20, 0, Math.PI * 2);
        ctx.fillStyle = '#f4d03f';
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();

        // ç»˜åˆ¶åå­—
        ctx.fillStyle = '#fff';
        ctx.font = '16px Microsoft YaHei';
        ctx.textAlign = 'center';
        ctx.fillText(gameState.player.name || 'ç©å®¶', pos.x, pos.y - 30);
      }

      // ç»˜åˆ¶ NPC
      if (currentMap.npcs) {
        for (const npc of currentMap.npcs) {
          const npcData = NPC_DATA[npc.npcId];
          if (!npcData) continue;

          // NPC åœ†åœˆ
          ctx.beginPath();
          ctx.arc(npc.x, npc.y, 25, 0, Math.PI * 2);
          ctx.fillStyle = '#9b59b6';
          ctx.fill();
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 2;
          ctx.stroke();

          // NPC å›¾æ ‡
          ctx.fillStyle = '#fff';
          ctx.font = '24px Arial';
          ctx.textAlign = 'center';
          ctx.fillText('ğŸ‘¤', npc.x, npc.y + 8);

          // NPC åå­—
          ctx.fillStyle = '#fff';
          ctx.font = '14px Microsoft YaHei';
          ctx.fillText(npcData.name, npc.x, npc.y - 35);
        }
      }

      // ç»˜åˆ¶ä¼ é€ç‚¹
      if (currentMap.portals) {
        for (const portal of currentMap.portals) {
          const targetMap = MAP_DATA[portal.targetMapId];
          if (!targetMap) continue;

          // ä¼ é€ç‚¹åœ†åœˆ
          ctx.beginPath();
          ctx.arc(portal.x, portal.y, 30, 0, Math.PI * 2);
          ctx.fillStyle = targetMap.unlocked ? '#3498db' : '#7f8c8d';
          ctx.fill();
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 2;
          ctx.stroke();

          // ä¼ é€ç‚¹å›¾æ ‡
          ctx.fillStyle = '#fff';
          ctx.font = '24px Arial';
          ctx.textAlign = 'center';
          ctx.fillText('ğŸŒ€', portal.x, portal.y + 8);

          // ä¼ é€ç‚¹åå­—
          ctx.fillStyle = '#fff';
          ctx.font = '12px Microsoft YaHei';
          ctx.fillText(targetMap.name, portal.x, portal.y - 40);
        }
      }

      // ç»˜åˆ¶æ€ªç‰©
      if (currentMap.monsters) {
        for (const monster of currentMap.monsters) {
          const monsterData = MONSTER_DATA[monster.monsterType];
          if (!monsterData) continue;

          // æ€ªç‰©åœ†åœˆ
          ctx.beginPath();
          ctx.arc(monster.x, monster.y, 25, 0, Math.PI * 2);
          ctx.fillStyle = '#e74c3c';
          ctx.fill();
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 2;
          ctx.stroke();

          // æ€ªç‰©å›¾æ ‡
          ctx.fillStyle = '#fff';
          ctx.font = '24px Arial';
          ctx.textAlign = 'center';
          ctx.fillText('ğŸ‘¾', monster.x, monster.y + 8);

          // æ€ªç‰©åå­—
          ctx.fillStyle = '#fff';
          ctx.font = '12px Microsoft YaHei';
          ctx.fillText(monsterData.name, monster.x, monster.y - 35);
        }
      }
    }

    // æ¸²æŸ“æˆ˜æ–—åœºæ™¯
    function renderBattle() {
      // æˆ˜æ–—èƒŒæ™¯
      ctx.fillStyle = '#2c2c54';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // æˆ˜æ–— UI
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 32px Microsoft YaHei';
      ctx.textAlign = 'center';
      ctx.fillText('æˆ˜æ–—ä¸­...', canvas.width / 2, 100);

      // TODO: æ¸²æŸ“æˆ˜æ–—è§’è‰²å’Œæ€ªç‰©
      // TODO: æ¸²æŸ“è¡€æ¡
      // TODO: æ¸²æŸ“æŠ€èƒ½æŒ‰é’®
    }

    // æ¸²æŸ“å¯¹è¯æ¡†
    function renderDialog() {
      // å¯¹è¯æ¡†èƒŒæ™¯
      const dialogHeight = 200;
      const dialogY = canvas.height - dialogHeight;

      ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
      ctx.fillRect(50, dialogY, canvas.width - 100, dialogHeight - 20);

      ctx.strokeStyle = '#667eea';
      ctx.lineWidth = 2;
      ctx.strokeRect(50, dialogY, canvas.width - 100, dialogHeight - 20);

      // NPC åå­—
      ctx.fillStyle = '#f093fb';
      ctx.font = 'bold 20px Microsoft YaHei';
      ctx.textAlign = 'left';
      ctx.fillText('NPC åå­—', 70, dialogY + 35);

      // å¯¹è¯å†…å®¹
      ctx.fillStyle = '#fff';
      ctx.font = '16px Microsoft YaHei';
      ctx.fillText('å¯¹è¯å†…å®¹...', 70, dialogY + 80);

      // TODO: æ¸²æŸ“å¯¹è¯é€‰é¡¹
    }

    // æ›´æ–° UI
    function updateUI() {
      if (!gameState || !gameState.player) return;

      const player = gameState.player;

      // æ›´æ–°è¡€æ¡
      const hpPercent = (player.hp / player.maxHp) * 100;
      document.getElementById('hp-bar-fill').style.width = hpPercent + '%';
      document.getElementById('hp-bar-text').textContent = `HP: ${player.hp}/${player.maxHp}`;

      // æ›´æ–°ç»éªŒæ¡
      const expPercent = (player.exp / player.expToNextLevel) * 100;
      document.getElementById('exp-bar-fill').style.width = expPercent + '%';
      document.getElementById('exp-bar-text').textContent = `EXP: ${player.exp}/${player.expToNextLevel}`;

      // æ›´æ–°ç­‰çº§å’Œé‡‘å¸
      document.getElementById('level-value').textContent = player.level;
      document.getElementById('gold-value').textContent = player.gold;

      // æ›´æ–°åœ°å›¾
      const mapNames = {
        'village': 'æ‘åº„',
        'forest': 'æ£®æ—',
        'cave': 'å±±æ´',
        'desert': 'æ²™æ¼ ',
        'snow': 'å†°åŸ',
        'volcano': 'ç«å±±',
        'demon_palace': 'é­”å®«'
      };
      document.getElementById('map-value').textContent = mapNames[gameState.currentMap] || gameState.currentMap;
    }

    // æ‰“å¼€è§’è‰²é¢æ¿
    window.openCharacterPanel = function() {
      if (!gameState || !gameState.player) return;

      const player = gameState.player;
      const content = document.getElementById('character-content');

      content.innerHTML = `
        <div class="character-section">
          <h3>ğŸ‘¤ åŸºæœ¬ä¿¡æ¯</h3>
          <div class="stat-row">
            <span class="stat-label">åå­—:</span>
            <span class="stat-value">${player.name || 'æœªå‘½å'}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">èŒä¸š:</span>
            <span class="stat-value">${player.class || 'æœªé€‰æ‹©'}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">ç­‰çº§:</span>
            <span class="stat-value">${player.level}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">ç»éªŒ:</span>
            <span class="stat-value">${player.exp}/${player.expToNextLevel}</span>
          </div>
        </div>
        <div class="character-section">
          <h3>âš”ï¸ æˆ˜æ–—å±æ€§</h3>
          <div class="stat-row">
            <span class="stat-label">ç”Ÿå‘½å€¼:</span>
            <span class="stat-value">${player.hp}/${player.maxHp}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">æ”»å‡»åŠ›:</span>
            <span class="stat-value">${player.attack}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">é˜²å¾¡åŠ›:</span>
            <span class="stat-value">${player.defense}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">é‡‘å¸:</span>
            <span class="stat-value">${player.gold}</span>
          </div>
        </div>
      `;

      openModal('character-modal');
    };

    // æ‰“å¼€èƒŒåŒ…é¢æ¿
    window.openInventoryPanel = function() {
      const content = document.getElementById('inventory-content');

      if (!gameState || gameState.inventory.length === 0) {
        content.innerHTML = '<p style="text-align: center; color: #999;">èƒŒåŒ…æ˜¯ç©ºçš„</p>';
      } else {
        content.innerHTML = gameState.inventory.map((item, index) => `
          <div class="character-section" style="margin-bottom: 10px;">
            <div class="stat-row">
              <span class="stat-label">åç§°:</span>
              <span class="stat-value">${item.name}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">æ•°é‡:</span>
              <span class="stat-value">${item.quantity}</span>
            </div>
          </div>
        `).join('');
      }

      openModal('inventory-modal');
    };

    // æ‰“å¼€æŠ€èƒ½é¢æ¿
    window.openSkillsPanel = function() {
      const content = document.getElementById('skills-content');

      if (!gameState || gameState.skills.length === 0) {
        content.innerHTML = '<p style="text-align: center; color: #999;">è¿˜æ²¡æœ‰å­¦ä¹ æŠ€èƒ½</p>';
      } else {
        content.innerHTML = gameState.skills.map((skill, index) => `
          <div class="character-section" style="margin-bottom: 10px;">
            <div class="stat-row">
              <span class="stat-label">åç§°:</span>
              <span class="stat-value">${skill.name}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">ç­‰çº§:</span>
              <span class="stat-value">${skill.level}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">æè¿°:</span>
              <span class="stat-value">${skill.description}</span>
            </div>
          </div>
        `).join('');
      }

      openModal('skills-modal');
    };

    // æ‰“å¼€ä»»åŠ¡é¢æ¿
    window.openTasksPanel = function() {
      const content = document.getElementById('tasks-content');

      if (!gameState || gameState.tasks.length === 0) {
        content.innerHTML = '<p style="text-align: center; color: #999;">è¿˜æ²¡æœ‰ä»»åŠ¡</p>';
      } else {
        content.innerHTML = gameState.tasks.map((task, index) => `
          <div class="character-section" style="margin-bottom: 10px;">
            <div class="stat-row">
              <span class="stat-label">ä»»åŠ¡:</span>
              <span class="stat-value">${task.title}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">çŠ¶æ€:</span>
              <span class="stat-value" style="color: ${task.completed ? '#27ae60' : '#e74c3c'};">
                ${task.completed ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}
              </span>
            </div>
            ${task.completed && task.rewards ? `
              <div class="stat-row">
                <span class="stat-label">å¥–åŠ±:</span>
                <span class="stat-value">é‡‘å¸ ${task.rewards.gold}, ç»éªŒ ${task.rewards.exp}</span>
              </div>
            ` : ''}
          </div>
        `).join('');
      }

      openModal('tasks-modal');
    };

    // ä¿å­˜æ¸¸æˆ
    window.saveGame = async function() {
      try {
        const success = await coordinatorAPI.saveGame();
        if (success) {
          showToast('æ¸¸æˆå·²ä¿å­˜');
        } else {
          showToast('ä¿å­˜å¤±è´¥');
        }
      } catch (error) {
        showToast('ä¿å­˜å¤±è´¥: ' + error.message);
      }
    };

    // æ‰“å¼€æ¨¡æ€æ¡†
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    // å…³é—­æ¨¡æ€æ¡†
    window.closeModal = function(modalId) {
      document.getElementById(modalId).classList.remove('active');
    };

    // æ˜¾ç¤ºåŠ è½½ç•Œé¢
    function showLoading(text, progress) {
      const loadingScreen = document.getElementById('loading-screen');
      const loadingText = document.getElementById('loading-text');
      const loadingProgress = document.getElementById('loading-progress');

      loadingText.textContent = text;
      loadingProgress.style.width = progress + '%';
    }

    // éšè—åŠ è½½ç•Œé¢
    function hideLoading() {
      document.getElementById('loading-screen').style.display = 'none';
    }

    // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // ç‚¹å‡»ç”»å¸ƒå¤„ç†
    canvas.addEventListener('click', async (e) => {
      if (!gameState) return;

      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      try {
        // æ£€æŸ¥æ¸¸æˆé˜¶æ®µ
        if (gameState.gamePhase === 'battle') {
          // æˆ˜æ–—ä¸­ï¼Œä¸å¤„ç†ç‚¹å‡»
          return;
        }

        if (gameState.gamePhase === 'dialog') {
          // å¯¹è¯ä¸­ï¼Œä¸å¤„ç†ç‚¹å‡»
          return;
        }

        // è·å–å½“å‰åœ°å›¾
        const currentMapId = gameState.currentMap;
        const currentMap = MAP_DATA[currentMapId];
        if (!currentMap) return;

        // æ£€æµ‹ç‚¹å‡» NPC
        if (currentMap.npcs) {
          for (const npc of currentMap.npcs) {
            const distance = Math.sqrt(Math.pow(x - npc.x, 2) + Math.pow(y - npc.y, 2));
            if (distance < 30) { // ç‚¹å‡»åŠå¾„
              // ç‚¹å‡»äº† NPCï¼Œè§¦å‘å¯¹è¯
              const npcData = NPC_DATA[npc.npcId];
              if (npcData) {
                gameState.gamePhase = 'dialog';
                gameState.currentNPC = npc.npcId;
                gameState.dialogQueue = npcData.dialogues || [];
                showToast(`ä¸ ${npcData.name} å¯¹è¯ä¸­`);
                updateUI();
                return;
              }
            }
          }
        }

        // æ£€æµ‹ç‚¹å‡»ä¼ é€ç‚¹
        if (currentMap.portals) {
          for (const portal of currentMap.portals) {
            const distance = Math.sqrt(Math.pow(x - portal.x, 2) + Math.pow(y - portal.y, 2));
            if (distance < 30) { // ç‚¹å‡»åŠå¾„
              // ç‚¹å‡»äº†ä¼ é€ç‚¹ï¼Œåˆ‡æ¢åœ°å›¾
              if (portal.targetMapId && MAP_DATA[portal.targetMapId]) {
                const targetMap = MAP_DATA[portal.targetMapId];

                // æ£€æŸ¥æ˜¯å¦è§£é”
                if (targetMap.unlocked) {
                  gameState.currentMap = portal.targetMapId;
                  // é‡ç½®ç©å®¶ä½ç½®åˆ°åœ°å›¾ä¸­å¿ƒ
                  gameState.player.position = { x: 300, y: 300 };
                  showToast(`è¿›å…¥ ${targetMap.name}`);
                  updateUI();
                  return;
                } else {
                  showToast(`åœ°å›¾ ${targetMap.name} æœªè§£é”`);
                  return;
                }
              }
            }
          }
        }

        // æ£€æµ‹ç‚¹å‡»æ€ªç‰©
        if (currentMap.monsters) {
          for (const monster of currentMap.monsters) {
            const distance = Math.sqrt(Math.pow(x - monster.x, 2) + Math.pow(y - monster.y, 2));
            if (distance < 30) { // ç‚¹å‡»åŠå¾„
              // ç‚¹å‡»äº†æ€ªç‰©ï¼Œå¼€å§‹æˆ˜æ–—
              const monsterData = MONSTER_DATA[monster.monsterType];
              if (monsterData) {
                gameState.gamePhase = 'battle';
                gameState.battleState = {
                  monsterId: monster.monsterType,
                  monsterName: monsterData.name,
                  monsterHp: monsterData.hp,
                  monsterMaxHp: monsterData.hp,
                  monsterAttack: monsterData.attack,
                  playerHp: gameState.player.hp,
                  playerMaxHp: gameState.player.maxHp,
                  battleLog: [`é‡åˆ° ${monsterData.name}ï¼`]
                };
                showToast(`æˆ˜æ–—å¼€å§‹ï¼${monsterData.name}`);
                updateUI();
                return;
              }
            }
          }
        }

        // ç§»åŠ¨ç©å®¶
        await coordinatorAPI.playerMove(x, y, 'down');
        updateUI();
      } catch (error) {
        showToast('æ“ä½œå¤±è´¥: ' + error.message);
      }
    });

    // çª—å£å¤§å°æ”¹å˜
    window.addEventListener('resize', resizeCanvas);

    // åˆå§‹åŒ–æ¸¸æˆ
    window.addEventListener('load', initGame);

    // å¯¼å‡ºå…¨å±€å‡½æ•°ï¼ˆç”¨äºè°ƒè¯•ï¼‰
    window.coordinatorAPI = coordinatorAPI;
    window.gameState = () => gameState;
  </script>
</body>
</html>

# 修仙游戏 - AI Native 架构设计

## 核心理念

**AI Native = 整个游戏架构都是 agent**

- NPC 就是 agent 本身
- 玩家和 NPC 的对话就是和 agent 的对话
- 每个模块（战斗、任务、商店）都是 agent

---

## 游戏架构（优化版）

### 设计原则

**合并相关 Agent，减少无效沟通和幻觉**：
> 如果两个 Agent 之间需要同一套上下文，最好就合并成一个 Agent，从而减少无效沟通和幻觉。

### Agent 架构

```
游戏引擎
├─ 玩家（前端界面）
├─ 对话&任务&商店 Agent（合并 1）
│  ├─ 村长（对话 + 任务）
│  ├─ 铁匠（对话 + 商店）
│  ├─ 药王（对话 + 商店）
│  └─ 仙师（对话 + 技能）
├─ 战斗 Agent（独立 2）
│  ├─ 战斗逻辑
│  ├─ 怪物 AI（普通怪物）
│  └─ Boss AI（Boss）
└─ 协调 Agent（独立 3）
   ├─ 全局状态管理
   ├─ Agent 通信
   └─ 存档管理
```

**优势**：
- Agent 数量减少（20+ → 3）
- 上下文连续（相关功能在一个 Agent 内）
- 沟通效率高（Agent 内直接调用）
- 减少幻觉（Agent 内共享上下文）

### 1. 玩家（前端界面）

```
玩家（前端）
├─ 角色界面
├─ 背包界面
├─ 技能界面
├─ 属性界面
└─ 对话界面
```

**职责**：
- 显示游戏画面
- 接收玩家输入
- 发送消息给 agent
- 接收 agent 的响应

### 2. 对话&任务&商店 Agent（合并）

**一个 Agent 包含所有 NPC，每个 NPC 有完整的功能**

```
对话&任务&商店 Agent
├─ 村长
│  ├─ 对话功能
│  ├─ 任务功能（分配任务、验证完成、发放奖励）
│  └─ 上下文：村长记忆 + 玩家任务历史
├─ 铁匠
│  ├─ 对话功能
│  ├─ 商店功能（出售装备、修理装备）
│  └─ 上下文：铁匠记忆 + 玩家交易历史
├─ 药王
│  ├─ 对话功能
│  ├─ 商店功能（出售药水）
│  └─ 上下文：药王记忆 + 玩家交易历史
└─ 仙师
   ├─ 对话功能
   ├─ 技能功能（传授技能、提供修炼建议）
   └─ 上下文：仙师记忆 + 玩家学习历史
```

**职责**：
- 接收玩家的对话
- 根据角色、记忆、目标响应
- 动态生成对话内容
- 分配任务、验证任务完成、发放奖励
- 出售商品、修理装备、传授技能

**示例对话**：
```
玩家：你好，村长
Agent（村长）：欢迎来到青木村，年轻的修仙者。你有什么需要帮助的吗？
玩家：我想开始修仙之路
Agent（村长）：很好的选择！修仙之路充满挑战，但也充满机遇。
Agent（村长）：你的第一步是击败村外的狼，证明你的实力。
Agent（村长）：完成了这个任务再来找我。
```

**优势**：
- 每个 NPC 都有自己的完整上下文
- 对话、任务、商店功能都在一个 Agent 内
- 上下文完全连续
- 没有跨 Agent 沟通
- 减少无效沟通和幻觉

### 3. 战斗 Agent（独立）

```
战斗 Agent
├─ 战斗逻辑
│  ├─ 计算伤害
│  ├─ 管理战斗状态
│  ├─ 生成战斗日志
│  └─ 处理战斗结果
├─ 怪物 AI（普通怪物）
│  ├─ 狼（简单攻击）
│  ├─ 熊（简单攻击 + 咆哮）
│  ├─ 骷髅（简单攻击）
│  └─ 僵尸（简单攻击）
└─ Boss AI（Boss）
   ├─ 智能攻击策略
   ├─ 召唤小怪
   └─ 施法
```

**职责**：
- 接收战斗请求
- 计算伤害
- 管理战斗状态
- 处理战斗结果
- 生成战斗日志
- 决定怪物和 Boss 的攻击策略

**示例**：
```
玩家攻击 Boss
战斗 Agent：计算伤害 = 玩家攻击 - Boss防御
战斗 Agent：更新 Boss 的生命值
战斗 Agent（Boss AI）：生命值降低到 50%，决定召唤小怪
战斗 Agent：Boss 召唤 3 只小怪
战斗 Agent：生成战斗日志 "Boss 召唤了 3 只小怪"
```

**优势**：
- 战斗逻辑集中在一个 Agent
- 怪物 AI 作为战斗逻辑的一部分
- Boss AI 作为战斗逻辑的一部分（更复杂）
- 上下文完全连续（战斗状态）
- 没有跨 Agent 沟通

### 4. 协调 Agent（独立）

```
协调 Agent
├─ 角色：游戏协调者
├─ 记忆：全局游戏状态
├─ 目标：协调所有 agent
└─ 能力：
  ├─ 管理游戏状态
  ├─ 协调 agent 之间的通信
  ├─ 处理游戏事件
  └─ 管理存档
```

**职责**：
- 管理全局游戏状态
- 协调 agent 之间的通信
- 处理游戏事件
- 管理存档

**优势**：
- 全局视角
- 协调所有 Agent
- 不被某个 Agent "污染"

---

## Agent 通信机制

### 玩家 → NPC Agent

```
玩家（前端界面）
  ↓ 发送消息
NPC Agent（会话 1）
  ↓ 响应消息
玩家（前端界面）
```

### NPC Agent → 任务 Agent

```
NPC Agent（会话 1）
  ↓ 发送任务请求
任务 Agent（会话 6）
  ↓ 生成任务
NPC Agent（会话 1）
  ↓ 返回任务给玩家
玩家（前端界面）
```

### 战斗 Agent → 怪物 Agent

```
战斗 Agent（会话 8）
  ↓ 发送战斗状态
怪物 Agent（会话 4）
  ↓ 决定攻击策略
战斗 Agent（会话 8）
  ↓ 执行攻击
```

---

## 技术实现

### Agent 创建

使用 `sessions_spawn` 创建独立的 agent 会话：

```javascript
// 创建 NPC Agent
const npcAgent = await sessions_spawn({
  task: "你是村长，负责引导新手玩家...",
  label: "NPC1-村长",
  thinking: "on"
});

// 发送消息给 NPC Agent
await sessions_send({
  sessionKey: npcAgent.sessionKey,
  message: "你好，村长"
});

// 接收 NPC Agent 的响应
const response = await sessions_history({
  sessionKey: npcAgent.sessionKey
});
```

### Agent 记忆

每个 agent 都有自己的记忆：

```javascript
// NPC Agent 记忆玩家历史
{
  "playerHistory": [
    {
      "timestamp": "2026-02-05 15:30",
      "message": "玩家：你好，村长",
      "response": "村长：欢迎来到青木村..."
    }
  ],
  "playerTasks": [
    {
      "taskId": "T1",
      "title": "击败 5 只狼",
      "progress": 0
    }
  ]
}
```

### Agent 通信

Agent 之间的通信通过 `sessions_send`：

```javascript
// NPC Agent 发送任务请求给任务 Agent
await sessions_send({
  sessionKey: taskAgent.sessionKey,
  message: "给玩家分配一个击杀任务"
});

// 任务 Agent 响应
const task = await taskAgent.generateTask("击杀", "狼", 5);
```

---

## 游戏流程示例

### 场景 1：开始游戏

1. 玩家创建角色
2. 进入游戏世界
3. 看到 NPC（村长）
4. 点击 NPC，打开对话界面
5. 前端发送消息给 NPC Agent
6. NPC Agent 响应，生成对话
7. NPC Agent 触发任务 Agent 分配任务
8. 任务 Agent 生成任务
9. NPC Agent 返回任务给玩家
10. 玩家接受任务

### 场景 2：战斗

1. 玩家探索地图
2. 遇到怪物（狼）
3. 玩家点击怪物，发送攻击请求
4. 战斗 Agent 接收请求，计算伤害
5. 怪物 Agent 接收战斗状态，决定攻击策略
6. 战斗 Agent 执行双方攻击
7. 更新战斗状态
8. 生成战斗日志
9. 怪物死亡
10. 任务 Agent 更新任务进度

### 场景 3：完成任务

1. 玩家返回 NPC
2. 点击 NPC，打开对话界面
3. 前端发送消息给 NPC Agent
4. NPC Agent 检查任务进度
5. 任务 Agent 验证任务完成
6. 任务 Agent 发放奖励
7. NPC Agent 返回奖励给玩家
8. 任务完成

---

## 优势总结

### 可玩性
- ✅ NPC 可以根据玩家的输入动态响应
- ✅ 每个 NPC 都有自己的记忆和个性
- ✅ 对话不再是预设脚本，而是真实的对话
- ✅ 玩家可以通过对话影响游戏世界
- ✅ Boss AI 更智能，更具有挑战性

### 开发难度
- ✅ 不需要写复杂的对话逻辑（agent 自己处理）
- ✅ 不需要写复杂的 AI 行为（agent 自己处理）
- ✅ 只需要定义 agent 的角色和目标
- ✅ 快速迭代（修改 agent 角色定义即可）

### 架构复杂度
- ✅ 模块化，每个 agent 独立
- ✅ 易于扩展（添加新的 NPC = 创建新的 agent）
- ✅ 易于维护（agent 的逻辑在 agent 内部）
- ✅ 易于测试（每个 agent 独立测试）

---

## 下一步

按照 AI Native 架构重新梳理任务：

1. 创建基础架构（协调 Agent）
2. 创建 NPC Agents
3. 创建系统 Agents（任务、商店、战斗）
4. 创建怪物 Agents
5. 集成所有 agent

---

*文档创建时间：2026-02-05*

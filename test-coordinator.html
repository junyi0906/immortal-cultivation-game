<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åè°ƒ Agent æµ‹è¯•</title>
  <style>
    body {
      font-family: 'Microsoft YaHei', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #e0e0e0;
    }

    h1 {
      text-align: center;
      color: #f4d03f;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }

    .test-section {
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(244,208,63,0.3);
    }

    h2 {
      color: #f4d03f;
      margin-top: 0;
    }

    button {
      background: linear-gradient(135deg, #f4d03f 0%, #16a085 100%);
      color: #1a1a2e;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    button:active {
      transform: translateY(0);
    }

    pre {
      background: rgba(0,0,0,0.3);
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      border-left: 3px solid #f4d03f;
    }

    .status {
      display: inline-block;
      padding: 5px 10px;
      margin: 5px 0;
      border-radius: 3px;
      font-weight: bold;
    }

    .success {
      background: #27ae60;
      color: white;
    }

    .error {
      background: #c0392b;
      color: white;
    }

    .info {
      background: #3498db;
      color: white;
    }

    .game-state {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
    }

    .state-card {
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 5px;
      border: 1px solid rgba(244,208,63,0.2);
    }

    .state-card h3 {
      margin-top: 0;
      color: #f4d03f;
    }
  </style>
</head>
<body>
  <h1>ğŸ® åè°ƒ Agent æµ‹è¯•</h1>

  <div class="test-section">
    <h2>1. åˆå§‹åŒ–æµ‹è¯•</h2>
    <button onclick="testInit()">åˆå§‹åŒ–æ¸¸æˆ</button>
    <button onclick="testReset()">é‡ç½®æ¸¸æˆ</button>
    <div id="initStatus"></div>
  </div>

  <div class="test-section">
    <h2>2. äº‹ä»¶å¤„ç†æµ‹è¯•</h2>
    <button onclick="testPlayerMove()">ç©å®¶ç§»åŠ¨</button>
    <button onclick="testStartBattle()">å¼€å§‹æˆ˜æ–—</button>
    <button onclick="testCompleteTask()">å®Œæˆä»»åŠ¡</button>
    <button onclick="testClickNPC()">ç‚¹å‡» NPC</button>
    <button onclick="testPlayerAttack()">ç©å®¶æ”»å‡»</button>
    <div id="eventStatus"></div>
  </div>

  <div class="test-section">
    <h2>3. å­˜æ¡£ç®¡ç†æµ‹è¯•</h2>
    <button onclick="testSaveGame()">ä¿å­˜æ¸¸æˆ</button>
    <button onclick="testLoadGame()">åŠ è½½æ¸¸æˆ</button>
    <button onclick="testHasSave()">æ£€æŸ¥å­˜æ¡£</button>
    <button onclick="testDeleteSave()">åˆ é™¤å­˜æ¡£</button>
    <div id="saveStatus"></div>
  </div>

  <div class="test-section">
    <h2>4. æ¸¸æˆçŠ¶æ€æŸ¥çœ‹</h2>
    <button onclick="displayGameState()">æ˜¾ç¤ºæ¸¸æˆçŠ¶æ€</button>
    <div id="gameStateDisplay" class="game-state"></div>
  </div>

  <div class="test-section">
    <h2>5. æµ‹è¯•æ—¥å¿—</h2>
    <pre id="testLog">// æµ‹è¯•æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</pre>
  </div>

  <script type="module">
    import coordinatorAPI from './js/coordinator-api.js';

    window.coordinatorAPI = coordinatorAPI;
    let gameState = null;

    // æ—¥å¿—å‡½æ•°
    function log(message, type = 'info') {
      const logElement = document.getElementById('testLog');
      const timestamp = new Date().toLocaleTimeString();
      const statusClass = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
      logElement.innerHTML = `<span class="status ${statusClass}">[${timestamp}] ${message}</span><br>` + logElement.innerHTML;
    }

    // æµ‹è¯•åˆå§‹åŒ–
    window.testInit = async function() {
      try {
        log('åˆå§‹åŒ–æ¸¸æˆ...', 'info');
        gameState = await coordinatorAPI.initGame();
        log('âœ… æ¸¸æˆåˆå§‹åŒ–æˆåŠŸ', 'success');
        document.getElementById('initStatus').innerHTML = '<span class="status success">âœ… åˆå§‹åŒ–æˆåŠŸ</span>';
        displayGameState();
      } catch (error) {
        log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
        document.getElementById('initStatus').innerHTML = `<span class="status error">âŒ ${error.message}</span>`;
      }
    };

    // æµ‹è¯•é‡ç½®
    window.testReset = async function() {
      try {
        log('é‡ç½®æ¸¸æˆ...', 'info');
        gameState = await coordinatorAPI.resetGame();
        log('âœ… æ¸¸æˆé‡ç½®æˆåŠŸ', 'success');
        document.getElementById('initStatus').innerHTML = '<span class="status success">âœ… é‡ç½®æˆåŠŸ</span>';
        displayGameState();
      } catch (error) {
        log(`âŒ é‡ç½®å¤±è´¥: ${error.message}`, 'error');
        document.getElementById('initStatus').innerHTML = `<span class="status error">âŒ ${error.message}</span>`;
      }
    };

    // æµ‹è¯•ç©å®¶ç§»åŠ¨
    window.testPlayerMove = async function() {
      try {
        log('æµ‹è¯•ç©å®¶ç§»åŠ¨...', 'info');
        const result = await coordinatorAPI.playerMove(100, 200, 'right');
        log(`âœ… ç©å®¶ç§»åŠ¨æˆåŠŸ: ${JSON.stringify(result.player?.position)}`, 'success');
        document.getElementById('eventStatus').innerHTML = '<span class="status success">âœ… ç§»åŠ¨æˆåŠŸ</span>';
        displayGameState();
      } catch (error) {
        log(`âŒ ç§»åŠ¨å¤±è´¥: ${error.message}`, 'error');
        document.getElementById('eventStatus').innerHTML = `<span class="status error">âŒ ${error.message}</span>`;
      }
    };

    // æµ‹è¯•å¼€å§‹æˆ˜æ–—
    window.testStartBattle = async function() {
      try {
        log('æµ‹è¯•å¼€å§‹æˆ˜æ–—...', 'info');
        const result = await coordinatorAPI.startBattle('monster1', 'wolf');
        log(`âœ… æˆ˜æ–—å¼€å§‹: ${result.message}`, 'success');
        document.getElementById('eventStatus').innerHTML = '<span class="status success">âœ… æˆ˜æ–—å¼€å§‹</span>';
        displayGameState();
      } catch (error) {
        log(`âŒ æˆ˜æ–—å¼€å§‹å¤±è´¥: ${error.message}`, 'error');
        document.getElementById('eventStatus').innerHTML = `<span class="status error">âŒ ${error.message}</span>`;
      }
    };

    // æµ‹è¯•å®Œæˆä»»åŠ¡
    window.testCompleteTask = async function() {
      try {
        // å…ˆæ·»åŠ ä¸€ä¸ªæµ‹è¯•ä»»åŠ¡
        if (!gameState || !gameState.tasks || gameState.tasks.length === 0) {
          log('âš ï¸ æ²¡æœ‰ä»»åŠ¡ï¼Œå…ˆæ·»åŠ æµ‹è¯•ä»»åŠ¡', 'info');
          // è¿™é‡Œéœ€è¦é€šè¿‡æ¸¸æˆçŠ¶æ€æ›´æ–°æ¥æ·»åŠ ä»»åŠ¡
          log('æç¤ºï¼šéœ€è¦å…ˆé€šè¿‡ NPC æ¥å—ä»»åŠ¡', 'info');
          return;
        }

        log('æµ‹è¯•å®Œæˆä»»åŠ¡...', 'info');
        const result = await coordinatorAPI.completeTask(gameState.tasks[0].id);
        log(`âœ… ä»»åŠ¡å®Œæˆ`, 'success');
        document.getElementById('eventStatus').innerHTML = '<span class="status success">âœ… ä»»åŠ¡å®Œæˆ</span>';
        displayGameState();
      } catch (error) {
        log(`âŒ ä»»åŠ¡å®Œæˆå¤±è´¥: ${error.message}`, 'error');
        document.getElementById('eventStatus').innerHTML = `<span class="status error">âŒ ${error.message}</span>`;
      }
    };

    // æµ‹è¯•ç‚¹å‡» NPC
    window.testClickNPC = async function() {
      try {
        log('æµ‹è¯•ç‚¹å‡» NPC...', 'info');
        const result = await coordinatorAPI.clickNPC('village_chief');
        log(`âœ… ç‚¹å‡» NPC æˆåŠŸ: ${result.message}`, 'success');
        document.getElementById('eventStatus').innerHTML = '<span class="status success">âœ… NPC ç‚¹å‡»æˆåŠŸ</span>';
        displayGameState();
      } catch (error) {
        log(`âŒ ç‚¹å‡» NPC å¤±è´¥: ${error.message}`, 'error');
        document.getElementById('eventStatus').innerHTML = `<span class="status error">âŒ ${error.message}</span>`;
      }
    };

    // æµ‹è¯•ç©å®¶æ”»å‡»
    window.testPlayerAttack = async function() {
      try {
        log('æµ‹è¯•ç©å®¶æ”»å‡»...', 'info');
        const result = await coordinatorAPI.playerAttack('monster1', 25);
        log(`âœ… æ”»å‡»æˆåŠŸ: ${result.message}`, 'success');
        document.getElementById('eventStatus').innerHTML = '<span class="status success">âœ… æ”»å‡»æˆåŠŸ</span>';
        displayGameState();
      } catch (error) {
        log(`âŒ æ”»å‡»å¤±è´¥: ${error.message}`, 'error');
        document.getElementById('eventStatus').innerHTML = `<span class="status error">âŒ ${error.message}</span>`;
      }
    };

    // æµ‹è¯•ä¿å­˜æ¸¸æˆ
    window.testSaveGame = async function() {
      try {
        log('ä¿å­˜æ¸¸æˆ...', 'info');
        const success = await coordinatorAPI.saveGame();
        if (success) {
          log('âœ… æ¸¸æˆä¿å­˜æˆåŠŸ', 'success');
          document.getElementById('saveStatus').innerHTML = '<span class="status success">âœ… ä¿å­˜æˆåŠŸ</span>';
        } else {
          log('âŒ ä¿å­˜å¤±è´¥', 'error');
          document.getElementById('saveStatus').innerHTML = '<span class="status error">âŒ ä¿å­˜å¤±è´¥</span>';
        }
      } catch (error) {
        log(`âŒ ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
        document.getElementById('saveStatus').innerHTML = `<span class="status error">âŒ ${error.message}</span>`;
      }
    };

    // æµ‹è¯•åŠ è½½æ¸¸æˆ
    window.testLoadGame = async function() {
      try {
        log('åŠ è½½æ¸¸æˆ...', 'info');
        const loadedState = await coordinatorAPI.loadGame();
        if (loadedState) {
          log('âœ… æ¸¸æˆåŠ è½½æˆåŠŸ', 'success');
          gameState = loadedState;
          document.getElementById('saveStatus').innerHTML = '<span class="status success">âœ… åŠ è½½æˆåŠŸ</span>';
          displayGameState();
        } else {
          log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°å­˜æ¡£', 'info');
          document.getElementById('saveStatus').innerHTML = '<span class="status info">âš ï¸ æ²¡æœ‰å­˜æ¡£</span>';
        }
      } catch (error) {
        log(`âŒ åŠ è½½å¤±è´¥: ${error.message}`, 'error');
        document.getElementById('saveStatus').innerHTML = `<span class="status error">âŒ ${error.message}</span>`;
      }
    };

    // æµ‹è¯•æ£€æŸ¥å­˜æ¡£
    window.testHasSave = function() {
      try {
        const hasSave = coordinatorAPI.hasSave();
        log(`å­˜æ¡£çŠ¶æ€: ${hasSave ? 'âœ… æœ‰å­˜æ¡£' : 'âš ï¸ æ²¡æœ‰å­˜æ¡£'}`, hasSave ? 'success' : 'info');
        document.getElementById('saveStatus').innerHTML = hasSave ?
          '<span class="status success">âœ… æœ‰å­˜æ¡£</span>' :
          '<span class="status info">âš ï¸ æ²¡æœ‰å­˜æ¡£</span>';
      } catch (error) {
        log(`âŒ æ£€æŸ¥å­˜æ¡£å¤±è´¥: ${error.message}`, 'error');
      }
    };

    // æµ‹è¯•åˆ é™¤å­˜æ¡£
    window.testDeleteSave = function() {
      try {
        log('åˆ é™¤å­˜æ¡£...', 'info');
        const success = coordinatorAPI.deleteSave();
        if (success) {
          log('âœ… å­˜æ¡£åˆ é™¤æˆåŠŸ', 'success');
          document.getElementById('saveStatus').innerHTML = '<span class="status success">âœ… åˆ é™¤æˆåŠŸ</span>';
        } else {
          log('âŒ åˆ é™¤å¤±è´¥', 'error');
          document.getElementById('saveStatus').innerHTML = '<span class="status error">âŒ åˆ é™¤å¤±è´¥</span>';
        }
      } catch (error) {
        log(`âŒ åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
        document.getElementById('saveStatus').innerHTML = `<span class="status error">âŒ ${error.message}</span>`;
      }
    };

    // æ˜¾ç¤ºæ¸¸æˆçŠ¶æ€
    window.displayGameState = function() {
      if (!coordinatorAPI.isGameInitialized()) {
        log('âš ï¸ æ¸¸æˆæœªåˆå§‹åŒ–', 'info');
        return;
      }

      try {
        const state = coordinatorAPI.getGameState();
        const display = document.getElementById('gameStateDisplay');

        display.innerHTML = `
          <div class="state-card">
            <h3>ğŸ‘¤ ç©å®¶ä¿¡æ¯</h3>
            <pre>${JSON.stringify(state.player, null, 2)}</pre>
          </div>
          <div class="state-card">
            <h3>ğŸ“ å½“å‰åœ°å›¾</h3>
            <pre>${JSON.stringify({
              currentMap: state.currentMap,
              position: state.player?.position
            }, null, 2)}</pre>
          </div>
          <div class="state-card">
            <h3>ğŸ’ èƒŒåŒ…</h3>
            <pre>${JSON.stringify(state.inventory, null, 2)}</pre>
          </div>
          <div class="state-card">
            <h3>âš”ï¸ æŠ€èƒ½</h3>
            <pre>${JSON.stringify(state.skills, null, 2)}</pre>
          </div>
          <div class="state-card">
            <h3>ğŸ“‹ ä»»åŠ¡</h3>
            <pre>${JSON.stringify(state.tasks, null, 2)}</pre>
          </div>
          <div class="state-card">
            <h3>ğŸ›¡ï¸ è£…å¤‡</h3>
            <pre>${JSON.stringify(state.equipment, null, 2)}</pre>
          </div>
        `;

        log('âœ… æ¸¸æˆçŠ¶æ€å·²æ›´æ–°', 'success');
      } catch (error) {
        log(`âŒ æ˜¾ç¤ºæ¸¸æˆçŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
      }
    };

    // åˆå§‹åŒ–æ—¶æ£€æŸ¥å­˜æ¡£
    window.addEventListener('load', () => {
      log('é¡µé¢åŠ è½½å®Œæˆ', 'info');
      window.testHasSave();
    });
  </script>
</body>
</html>
